<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“Š å†å²æŠ¥å‘Š (æœ¬åœ°å­˜å‚¨)</title>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background-color: #f4f4f4; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); }
        h2 { color: #a04000; border-bottom: 2px solid #ff9933; padding-bottom: 5px; margin-top: 0; }
        
        .header-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        #clear-history-btn { background-color: #d9534f; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        #clear-history-btn:disabled { background-color: #ccc; cursor: not-allowed; }
        .back-link { font-size: 14px; color: #007bff; text-decoration: none; }

        .report-summary { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 4px; background-color: #f9f9f9; }
        .report-summary p { margin: 5px 0; font-size: 16px; }
        .total-highlight { font-size: 20px; font-weight: bold; color: #a04000; }

        .history-list { list-style: none; padding: 0; }
        .record-item { background-color: #fff; border: 1px solid #eee; margin-bottom: 15px; padding: 15px; border-radius: 4px; }
        .record-header { display: flex; justify-content: space-between; font-weight: bold; border-bottom: 1px dashed #ccc; padding-bottom: 5px; margin-bottom: 10px; }
        .record-details ul { list-style: disc; margin: 5px 0 0 20px; padding: 0; font-size: 14px; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header-controls">
            <h2>ğŸ“Š å†å²æŠ¥å‘Š (æœ¬åœ°)</h2>
            <a href="order_system.html" class="back-link">â† è¿”å›ç‚¹å•ç³»ç»Ÿ</a>
        </div>
        
        <div id="report-summary" class="report-summary">
            <p>æ€»ç»“: æ­£åœ¨åŠ è½½...</p>
        </div>

        <div class="header-controls" style="margin-top: 0;">
            <h3>æ‰€æœ‰å·²ç»“è´¦è®°å½•</h3>
            <button id="clear-history-btn" disabled>æ¸…ç©ºå†å²è®°å½•</button>
        </div>

        <ul id="history-list" class="history-list">
            <p style="text-align: center; color: #888;">æš‚æ— å†å²è®°å½•ã€‚</p>
        </ul>
    </div>

    <script>
        const HISTORY_KEY = 'bbq_history_records';
        const historyList = document.getElementById('history-list');
        const reportSummary = document.getElementById('report-summary');
        const clearHistoryBtn = document.getElementById('clear-history-btn');
        let historyRecords = [];

        function loadHistory() {
            try {
                const data = localStorage.getItem(HISTORY_KEY);
                historyRecords = data ? JSON.parse(data) : [];
                renderReport();
            } catch (e) {
                console.error("åŠ è½½å†å²è®°å½•å¤±è´¥:", e);
                historyList.innerHTML = `<p style="color: red; text-align: center;">åŠ è½½è®°å½•å¤±è´¥ã€‚</p>`;
            }
        }

        function saveHistory() {
            localStorage.setItem(HISTORY_KEY, JSON.stringify(historyRecords));
        }

        function calculateSummary() {
            const totalRecords = historyRecords.length;
            const totalAmount = historyRecords.reduce((sum, record) => sum + record.total_amount, 0);

            reportSummary.innerHTML = `
                <p>å·²å®Œæˆæ€»è®¢å•æ•°: <span class="total-highlight">${totalRecords}</span> ç¬”</p>
                <p>æ€»é”€å”®é¢: <span class="total-highlight">${totalAmount.toFixed(0)}</span> Ks</p>
            `;
            clearHistoryBtn.disabled = totalRecords === 0;
        }

        function renderReport() {
            historyList.innerHTML = '';
            calculateSummary();

            if (historyRecords.length === 0) {
                historyList.innerHTML = `<p style="text-align: center; color: #888;">æš‚æ— å†å²è®°å½•ã€‚</p>`;
                return;
            }

            historyRecords.forEach(record => {
                const li = document.createElement('li');
                li.className = 'record-item';

                // è®¢å•å¤´
                const header = document.createElement('div');
                header.className = 'record-header';
                header.innerHTML = `
                    <span>${record.customer} (ç»“è´¦æ—¶é—´: ${record.timestamp})</span>
                    <span>æ€»è®¡: <span style="color:#d9534f;">${record.total_amount.toFixed(0)} Ks</span></span>
                `;
                li.appendChild(header);

                // è®¢å•è¯¦æƒ…
                const details = document.createElement('div');
                details.className = 'record-details';
                details.innerHTML = '<h4>è®¢å•è¯¦æƒ…:</h4>';
                
                const ul = document.createElement('ul');
                const itemKeys = Object.keys(record.items);
                
                itemKeys.forEach(itemId => {
                    const item = record.items[itemId];
                    const itemTotal = item.itemData.price * item.quantity;
                    const itemLi = document.createElement('li');
                    itemLi.textContent = `${item.itemData.name} x ${item.quantity} ä»½ (${item.itemData.price.toFixed(0)} Ks/ä»½) = ${itemTotal.toFixed(0)} Ks`;
                    ul.appendChild(itemLi);
                });

                details.appendChild(ul);
                li.appendChild(details);
                historyList.appendChild(li);
            });
        }
        
        function clearHistory() {
            if (confirm("è­¦å‘Šï¼æ¸…ç©ºå†å²è®°å½•åå°†æ— æ³•æ¢å¤ã€‚æ‚¨ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å·²ç»“è´¦è®°å½•å—ï¼Ÿ")) {
                historyRecords = [];
                saveHistory();
                renderReport();
                alert("å†å²è®°å½•å·²æ¸…ç©ºã€‚");
            }
        }

        // --- åˆå§‹åŒ– ---
        document.addEventListener('DOMContentLoaded', () => {
            loadHistory();
            clearHistoryBtn.addEventListener('click', clearHistory);
        });
    </script>
</body>
</html>