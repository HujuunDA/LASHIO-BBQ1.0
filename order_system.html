<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¢ çƒ§çƒ¤è®¢å•è®¡ç®—å™¨ - æœ¬åœ°å­˜å‚¨ç‰ˆ</title>
    
    <style>
        /* CSS æ ·å¼ (ä¿æŒä¸å˜) */
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background-color: #f4f4f4; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background-color: #fff; padding: 20px; box-shadow: 0 0 15px rgba(0, 0, 0, 0.1); border-radius: 8px; display: flex; gap: 20px; flex-wrap: wrap; }
        .section { padding: 15px; border-radius: 6px; background-color: #fefefe; border: 1px solid #ddd; }
        h2 { color: #a04000; border-bottom: 2px solid #ff9933; padding-bottom: 5px; margin-top: 0; }
        
        /* èœå•åŒº */
        #menu-section { flex: 3; min-width: 300px; }
        #category-tabs { display: flex; overflow-x: auto; border-bottom: 1px solid #ff9933; margin-bottom: 10px; }
        .category-button { background-color: #f0f0f0; border: none; padding: 10px 15px; cursor: pointer; margin-right: 5px; border-top-left-radius: 4px; border-top-right-radius: 4px; font-weight: bold; white-space: nowrap; }
        .category-button.active { background-color: #ffaa55; color: white; border: 1px solid #ff9933; border-bottom: none; margin-bottom: -1px; }

        .menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-top: 10px; }
        .menu-item { background-color: #ffaa55; color: white; border: none; padding: 15px 10px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; text-align: center; line-height: 1.3; transition: background-color 0.2s; }
        .menu-item:hover { background-color: #ff8833; }

        /* è®¢å•åŒº */
        #order-container { flex: 2; min-width: 280px; display: flex; flex-direction: column; }
        #order-tabs { display: flex; overflow-x: auto; border-bottom: 1px solid #ccc; margin-bottom: 10px; }
        .tab-button { background-color: #e0e0e0; border: none; padding: 10px 15px; cursor: pointer; margin-right: 5px; border-top-left-radius: 4px; border-top-right-radius: 4px; font-weight: bold; white-space: nowrap; }
        .tab-button.active { background-color: #fff; border: 1px solid #ccc; border-bottom: none; margin-bottom: -1px; color: #a04000; }
        
        #order-list { list-style: none; padding: 0; margin: 15px 0; }
        .order-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px dashed #eee; font-size: 15px; }
        .item-name { flex-grow: 1; font-weight: bold; }
        .quantity-controls { display: flex; align-items: center; margin: 0 10px; }
        .qty-btn { background-color: #a04000; color: white; border: none; width: 25px; height: 25px; border-radius: 4px; cursor: pointer; font-size: 16px; line-height: 1; padding: 0; }
        .qty-btn:hover { background-color: #7a3000; }
        .item-qty { margin: 0 10px; width: 20px; text-align: center; font-weight: bold; }
        .item-subtotal { min-width: 60px; text-align: right; font-weight: bold; color: #d9534f; }
        .empty-message { text-align: center; color: #888; padding: 20px 0; }

        .total-box { text-align: right; font-size: 24px; font-weight: bold; padding: 10px 0; border-top: 2px solid #ff9933; margin-top: 15px; color: #a04000; }
        #clear-order-btn { width: 100%; padding: 10px; background-color: #d9534f; color: white; border: none; border-radius: 5px; font-size: 18px; cursor: pointer; margin-top: 10px; }
        #clear-order-btn:disabled { background-color: #ccc; cursor: not-allowed; }
        
        .top-links a { margin-left: 10px; font-size: 14px; color: #007bff; }
    </style>
</head>
<body>

    <div class="container">
        <div id="menu-section" class="section">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>ğŸ”¥ èœå•</h2>
                <div class="top-links">
                    <a href="menu_editor.html">âš™ï¸ ç¼–è¾‘èœå•]</a>
                    <a href="history_report.html">[ğŸ“Š æŸ¥çœ‹æŠ¥å‘Š]</a>
                </div>
            </div>

            <div id="category-tabs">
                </div>

            <div id="menu-items" class="menu-grid">
                <p style="text-align: center; color: #888;">æ­£åœ¨åŠ è½½èœå•é¡¹...</p>
            </div>
        </div>

        <div id="order-container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <div id="order-tabs">
                    </div>
            </div>
            
            <div id="order-section" class="section">
                <h2>ğŸ“ è®¢å• (<span id="current-customer-name">æ¡Œå· 1</span>)</h2>
                <ul id="order-list">
                    <li class="empty-message">æš‚æ— è®¢å•ï¼Œè¯·ä»èœå•æ·»åŠ é¡¹ç›®ã€‚</li>
                </ul>

                <div class="total-box">
                    æ€»è®¡: <span id="total-amount">0</span> Ks
                </div>
                
                <button id="clear-order-btn" class="action-btn clear-btn" disabled>æ¸…ç©ºå½“å‰è®¢å• (å·²ç»“è´¦)</button>
            </div>
        </div>
    </div>

    <script>
        const FIXED_TABLE_COUNT = 10;
        const MENU_KEY = 'bbq_menu_items';
        const ORDERS_KEY = 'bbq_all_orders';
        const HISTORY_KEY = 'bbq_history_records';
        const CURRENT_TABLE_KEY = 'bbq_current_table'; 
        
        // æ•°æ®å˜é‡ (ç°åœ¨è¿™äº›å˜é‡ä» localStorage è¯»å–/å†™å…¥)
        let menuItems = [];
        let allOrders = {};
        let historyRecords = [];
        let currentTable = ''; 
        
        // å£°éŸ³è®¾ç½® (éœ€è¦æ‚¨æä¾› add.mp3, remove.mp3, checkout.mp3)
        const addItemSound = new Audio('add.mp3'); 
        const removeItemSound = new Audio('remove.mp3'); 
        const checkoutSound = new Audio('checkout.mp3'); 

        // DOM å…ƒç´ 
        const orderList = document.getElementById('order-list');
        const totalAmountSpan = document.getElementById('total-amount');
        const menuItemsContainer = document.getElementById('menu-items');
        const clearOrderButton = document.getElementById('clear-order-btn');
        const orderTabsContainer = document.getElementById('order-tabs');
        const currentTableNameSpan = document.getElementById('current-customer-name'); 
        const categoryTabsContainer = document.getElementById('category-tabs'); 

        let currentCategory = ''; 

        // --- LocalStorage æ•°æ®è¯»å†™å‡½æ•° ---
        
        function loadData() {
            try {
                // 1. åŠ è½½èœå•
                const menuData = localStorage.getItem(MENU_KEY);
                menuItems = menuData ? JSON.parse(menuData) : [];

                // 2. åŠ è½½æ‰€æœ‰è®¢å•
                const ordersData = localStorage.getItem(ORDERS_KEY);
                allOrders = ordersData ? JSON.parse(ordersData) : {};
                
                // 3. åŠ è½½å†å²è®°å½•
                const historyData = localStorage.getItem(HISTORY_KEY);
                historyRecords = historyData ? JSON.parse(historyData) : [];

                // 4. åŠ è½½å½“å‰æ¡Œå·
                currentTable = localStorage.getItem(CURRENT_TABLE_KEY) || `æ¡Œå· 1`;

                // ç¡®ä¿æ‰€æœ‰æ¡Œå·è¢«åˆå§‹åŒ–
                initializeTables(); 
                
            } catch (e) {
                console.error("åŠ è½½æ•°æ®å¤±è´¥:", e);
                menuItemsContainer.innerHTML = `<p style="color: red;">æœ¬åœ°å­˜å‚¨åŠ è½½å¤±è´¥ï¼Œè¯·å°è¯•æ¸…ç†æµè§ˆå™¨ç¼“å­˜ã€‚</p>`;
            }
        }
        
        function initializeTables() {
             let isModified = false;
             for (let i = 1; i <= FIXED_TABLE_COUNT; i++) {
                const tableName = `æ¡Œå· ${i}`;
                if (!allOrders.hasOwnProperty(tableName)) {
                    allOrders[tableName] = {}; // åˆå§‹åŒ–ä¸ºç©ºè®¢å•
                    isModified = true;
                }
            }
            if(isModified) {
                saveOrders();
            }
        }

        function saveOrders() {
            localStorage.setItem(ORDERS_KEY, JSON.stringify(allOrders));
            localStorage.setItem(CURRENT_TABLE_KEY, currentTable);
            // æœ¬åœ°å­˜å‚¨éœ€è¦æ‰‹åŠ¨è°ƒç”¨æ¸²æŸ“å‡½æ•°æ¥åˆ·æ–°ç•Œé¢
            renderOrderTabs();
            renderOrder();
        }

        function saveHistory() {
            localStorage.setItem(HISTORY_KEY, JSON.stringify(historyRecords));
        }

        // --- æ ¸å¿ƒè®¢å•æ“ä½œå‡½æ•° ---

        function addItemToOrder(itemId) {
            const itemData = menuItems.find(item => item.id === itemId);
            if (!itemData) return;
            const order = allOrders[currentTable];
            
            // ç¡®ä¿ä¿å­˜åˆ°è®¢å•çš„æ•°æ®åŒ…å« itemData çš„å…³é”®ä¿¡æ¯
            const itemToSave = { 
                id: itemData.id, 
                name: itemData.name, 
                price: itemData.price, 
                category: itemData.category 
            };

            order[itemId] = order[itemId] ? {...order[itemId], quantity: order[itemId].quantity + 1} : { itemData: itemToSave, quantity: 1 };
            
            saveOrders(); 
            addItemSound.play().catch(e => console.log('æ— æ³•æ’­æ”¾æ·»åŠ å£°éŸ³:', e)); 
        }

        function decreaseItemQuantity(itemId) {
            const order = allOrders[currentTable];
            if (order[itemId]) {
                order[itemId].quantity -= 1;
                const isRemoved = order[itemId].quantity <= 0;
                if (isRemoved) {
                    delete order[itemId];
                }

                saveOrders(); 
                removeItemSound.play().catch(e => console.log('æ— æ³•æ’­æ”¾ç§»é™¤å£°éŸ³:', e));
            }
        }

        function clearOrder() {
            const orderData = allOrders[currentTable];
            if (Object.keys(orderData).length > 0) {
                const total = calculateTotal(); 
                
                // 1. åˆ›å»ºå†å²è®°å½•å¯¹è±¡
                const historyEntry = {
                    customer: currentTable, 
                    total_amount: total,
                    items: JSON.parse(JSON.stringify(orderData)), 
                    timestamp: new Date().toLocaleString(), // æœ¬åœ°ç‰ˆä½¿ç”¨æœ¬åœ°æ—¶é—´æ ¼å¼
                };

                // 2. æ·»åŠ å†å²è®°å½•
                historyRecords.unshift(historyEntry); // æ”¾åœ¨æœ€å‰é¢
                saveHistory();

                alert(`å·²å®Œæˆ ${currentTable} çš„è®¢å•ï¼Œæ€»é‡‘é¢: ${total.toFixed(0)} Ksã€‚è®¢å•å·²è®°å½•ã€‚`);
                checkoutSound.play().catch(e => console.log('æ— æ³•æ’­æ”¾ç»“è´¦å£°éŸ³:', e));
            }
            
            // 3. æ¸…ç©ºè®¢å•
            allOrders[currentTable] = {};
            saveOrders();
        }

        // --- èœå•å’Œè®¢å•æ¸²æŸ“/é€»è¾‘å‡½æ•° (ä¸ Supabase ç‰ˆé€»è¾‘ç›¸åŒ) ---

        function calculateTotal() {
            const order = allOrders[currentTable] || {};
            let total = 0;
            for (const itemId in order) {
                const item = order[itemId];
                // å°è¯•ä»å½“å‰èœå•åˆ—è¡¨è·å–æœ€æ–°ä»·æ ¼ï¼Œå¦åˆ™ä½¿ç”¨è®¢å•ä¸­ç¼“å­˜çš„ä»·æ ¼
                const currentItemData = menuItems.find(m => m.id === item.itemData.id);
                const price = currentItemData ? currentItemData.price : item.itemData.price;
                total += price * item.quantity;
            }
            totalAmountSpan.textContent = total.toFixed(0);
            clearOrderButton.disabled = total === 0;
            return total;
        }

        function switchCategory(categoryName) {
            currentCategory = categoryName;
            renderCategoryTabs();
            renderMenu();
        }
        
        function getUniqueCategories() {
            return [...new Set(menuItems.map(item => item.category || 'æœªåˆ†ç±»'))].sort();
        }

        function renderCategoryTabs() {
            categoryTabsContainer.innerHTML = '';
            const categories = getUniqueCategories();

            if (categories.length === 0) {
                 categoryTabsContainer.innerHTML = `<p style="color:#d9534f; padding: 10px 0;">èœå•ä¸ºç©ºï¼Œè¯·å…ˆåœ¨ [ç¼–è¾‘èœå•] ä¸­æ·»åŠ åˆ†ç±»ã€‚</p>`;
                 return;
            }
            
            if (!currentCategory || !categories.includes(currentCategory)) {
                currentCategory = categories[0] || '';
            }

            categories.forEach(category => {
                const button = document.createElement('button');
                button.className = 'category-button';
                button.textContent = category;
                
                if (category === currentCategory) {
                    button.classList.add('active');
                }
                
                button.addEventListener('click', () => switchCategory(category));
                categoryTabsContainer.appendChild(button);
            });
        }
        
        function renderMenu() {
            menuItemsContainer.innerHTML = '';
            
            if (menuItems.length === 0 || !currentCategory) {
                 const message = menuItems.length === 0 ? "èœå•ä¸ºç©ºï¼è¯·ç‚¹å‡» [ç¼–è¾‘èœå•] æ·»åŠ é¡¹ç›®ã€‚" : "è¯·é€‰æ‹©ä¸€ä¸ªåˆ†ç±»ã€‚";
                 menuItemsContainer.innerHTML = `<p style="text-align: center; color: #888;">${message}</p>`;
                 return;
            }

            const itemsToDisplay = menuItems.filter(item => (item.category || 'æœªåˆ†ç±»') === currentCategory);

            if (itemsToDisplay.length === 0) {
                 menuItemsContainer.innerHTML = `<p style="text-align: center; color: #888;">å½“å‰åˆ†ç±»ä¸‹æš‚æ— èœå•é¡¹ã€‚</p>`;
                 return;
            }

            itemsToDisplay.forEach(item => {
                const button = document.createElement('button');
                button.className = 'menu-item';
                button.dataset.id = item.id;
                button.innerHTML = `${item.name} <br> (${item.price.toFixed(0)} Ks)`;
                button.addEventListener('click', () => addItemToOrder(item.id));
                menuItemsContainer.appendChild(button);
            });
        }

        function renderOrder() {
            const order = allOrders[currentTable] || {};
            orderList.innerHTML = ''; 
            currentTableNameSpan.textContent = currentTable; 

            const itemIds = Object.keys(order);
            
            if (itemIds.length === 0) {
                orderList.innerHTML = `<li class="empty-message">æš‚æ— è®¢å•ï¼Œè¯·ä»èœå•æ·»åŠ é¡¹ç›®ã€‚</li>`;
            } else {
                itemIds.forEach(itemId => {
                    const item = order[itemId];
                    const li = document.createElement('li');
                    li.className = 'order-item';
                    
                    const currentItemData = menuItems.find(m => m.id === item.itemData.id);
                    const price = currentItemData ? currentItemData.price : item.itemData.price;
                    const subtotal = price * item.quantity;

                    li.innerHTML = `
                        <span class="item-name">${item.itemData.name}</span>
                        <span class="item-price">(${price.toFixed(0)} Ks/ä»½)</span>
                        <div class="quantity-controls">
                            <button data-id="${itemId}" class="qty-btn minus-btn">-</button>
                            <span class="item-qty">${item.quantity}</span>
                            <button data-id="${itemId}" class="qty-btn plus-btn">+</button>
                        </div>
                        <span class="item-subtotal">${subtotal.toFixed(0)} Ks</span>
                    `;
                    orderList.appendChild(li);
                });
                
                document.querySelectorAll('.qty-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const id = parseInt(e.currentTarget.dataset.id); 
                        if (e.currentTarget.classList.contains('plus-btn')) {
                            addItemToOrder(id);
                        } else if (e.currentTarget.classList.contains('minus-btn')) {
                            decreaseItemQuantity(id);
                        }
                    });
                });
            }
            calculateTotal(); 
        }

        function switchTable(tableName) {
            currentTable = tableName;
            saveOrders(); // ä¿å­˜å½“å‰æ¡Œå·ï¼Œå¹¶è§¦å‘æ¸²æŸ“
        }

        function renderOrderTabs() {
            orderTabsContainer.innerHTML = '';
            
            for (let i = 1; i <= FIXED_TABLE_COUNT; i++) {
                const tableName = `æ¡Œå· ${i}`;
                const button = document.createElement('button');
                button.className = 'tab-button';
                
                const hasOrder = allOrders[tableName] && Object.keys(allOrders[tableName]).length > 0;

                if (tableName === currentTable) {
                    button.classList.add('active');
                }
                
                button.textContent = hasOrder ? `${tableName} *` : tableName;
                
                button.addEventListener('click', () => switchTable(tableName));
                orderTabsContainer.appendChild(button);
            }
        }
        
        // --- åˆå§‹åŒ– ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData(); 
            // é¦–æ¬¡åŠ è½½åï¼Œæ¸²æŸ“èœå•å’Œè®¢å•åŒºåŸŸ
            renderCategoryTabs();
            renderMenu();
            renderOrderTabs();
            renderOrder();
            
            clearOrderButton.addEventListener('click', clearOrder);
        });
    </script>
</body>
</html>