<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¶å…¥æ±‡æ€»</title>
    <style>
        /* --- çƒ§çƒ¤æ©™è‰²ä¸»é¢˜ CSS ä¿®æ”¹ --- */
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f7f7f7;
            color: #333;
            padding-top: 0; 
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background-color: #fff;
            min-height: 100vh;
            padding-bottom: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .header-bar {
            background-color: #FF8C00; /* ä¸»è‰²ï¼šæ©™è‰² */
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.5em;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .header-button {
            background: #FF4500; /* å¼ºè°ƒè‰²ï¼šæ©™çº¢è‰² */
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .summary-panel {
            display: flex;
            justify-content: space-around;
            padding: 20px;
            background-color: #FFF3E0; /* æµ…æ©™è‰²èƒŒæ™¯ */
            margin: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }

        .summary-item {
            text-align: center;
        }

        .summary-item .value {
            font-size: 2em;
            font-weight: bold;
            color: #FF8C00; 
            margin-top: 5px;
        }

        .summary-item .label {
            font-size: 0.9em;
            color: #666;
        }

        .order-list-section {
            margin: 20px;
        }

        .section-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #FF4500; 
            border-bottom: 2px solid #FFDAB9; 
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .pending-order, .closed-order {
            background-color: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        .closed-order {
            border-left: 5px solid #34c759; /* ç»¿è‰²æ ‡è¯†å·²ç»“ç®— */
        }
        
        .order-header {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .order-details ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        .order-details li {
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            padding: 3px 0;
            color: #555;
        }

        .total-line {
            font-weight: bold;
            padding-top: 10px;
            border-top: 1px dashed #eee;
            margin-top: 5px;
            color: #333;
        }
        
        .no-pending, .no-closed {
            text-align: center;
            color: #999;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }
        
        .clear-all-container {
            text-align: center;
            padding: 20px;
        }
        
        .clear-button {
            background-color: #ff3b30; /* çº¢è‰² */
        }

        /* æ–°å¢åŠ è½½å±‚æ ·å¼ */
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.9); color: #FF8C00; display: flex; justify-content: center; align-items: center; font-size: 24px; font-weight: bold; z-index: 1000; transition: opacity 0.3s; }

    </style>
</head>
<body>
    
    <div id="loading-overlay" style="display: flex;"> æ­£åœ¨ä»äº‘ç«¯åŠ è½½æ•°æ®... ğŸš€ </div>

    <div class="container">
        <div class="header-bar">
            <span>ğŸ’° è´¢åŠ¡æ±‡æ€»</span>
            <button class="header-button" onclick="goToOrderingPage()">è¿”å›ç‚¹å•</button>
        </div>

        <div class="summary-panel">
            <div class="summary-item">
                <div class="label">ç´¯è®¡æ€»æ”¶å…¥ (Ks)</div>
                <div class="value" id="totalIncome">0</div>
            </div>
            <div class="summary-item">
                <div class="label">å·²ç»“ç®—è®¢å•æ•°</div>
                <div class="value" id="closedOrdersCount">0</div>
            </div>
            <div class="summary-item">
                <div class="label">æœªç»“ç®—è®¢å•æ•°</div>
                <div class="value" id="pendingOrdersCount">0</div>
            </div>
        </div>

        <div class="order-list-section">
            <div class="section-title"> ğŸ”´ æœªç»“ç®—è®¢å• (è¿›è¡Œä¸­) </div>
            <div id="pendingOrdersList">
                </div>
        </div>

        <div class="closed-orders-section">
            <div class="section-title"> ğŸŸ¢ å·²ç»“ç®—è®°å½• (æŒ‰æœ€æ–°æ’åº) </div>
            <div id="closedOrdersList">
                </div>
            <div class="clear-all-container">
                <button class="header-button clear-button" onclick="clearAllIncome()">æ¸…ç©ºæ‰€æœ‰è®°å½•</button>
            </div>
        </div>

    </div>

<script>
    // --- Cloud Sync Configuration (å·²æ›´æ–°ä¸ºæ‚¨æä¾›çš„æ–°ä¿¡æ¯) ---
    const JSONBIN_ID = '69174442ae596e708f5901ae'; 
    const JSONBIN_MASTER_KEY = '$2a$10$ol9N5tLV0G2AnDYaF4sO4O2l0RoR8OSXagA4IUy2wiwdntZDuzRh2';
    const JSONBIN_URL = `https://api.jsonbin.io/v3/b/${JSONBIN_ID}`;

    let globalCloudData = {
        menu_data: [],
        table_orders: {}, 
        income_data: { total: 0, closedOrders: [] },
        purchase_data: { productTemplate: {}, cartData: [] }
    };
    let tableOrdersMap = new Map();
    let incomeData = globalCloudData.income_data;

    // --- Cloud Utilities ---
    async function loadCloudData() {
        try {
            const response = await fetch(JSONBIN_URL + '/latest', {
                method: 'GET',
                headers: {
                    'X-Master-Key': JSONBIN_MASTER_KEY,
                    'Content-Type': 'application/json'
                }
            });
            if (!response.ok) throw new Error(`Cloud fetch failed: ${response.statusText}`);
            const data = await response.json();
            if (data.record) {
                globalCloudData = data.record;
                if (!globalCloudData.table_orders) globalCloudData.table_orders = {};
                if (!globalCloudData.income_data) globalCloudData.income_data = { total: 0, closedOrders: [] };
                tableOrdersMap = new Map(Object.entries(globalCloudData.table_orders));
                incomeData = globalCloudData.income_data;
            }
        } catch (error) {
            console.error("åŠ è½½äº‘ç«¯æ•°æ®å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°é»˜è®¤æ•°æ®ã€‚", error);
            alert("äº‘ç«¯æ•°æ®åŠ è½½å¤±è´¥ï¼è¯·æ£€æŸ¥ JSONBin é…ç½®æˆ–ç½‘ç»œã€‚");
        }
    }

    async function saveCloudData() {
        // åœ¨è¿™é‡Œåªéœ€æ›´æ–° income_dataï¼Œtable_orders åœ¨ index.html ä¸­æ›´æ–°
        globalCloudData.income_data = incomeData;
        try {
            const response = await fetch(JSONBIN_URL, {
                method: 'PUT',
                headers: {
                    'X-Master-Key': JSONBIN_MASTER_KEY,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(globalCloudData)
            });
            if (!response.ok) throw new Error(`Cloud save failed: ${response.statusText}`);
            console.log("æ”¶å…¥æ•°æ®å·²æˆåŠŸåŒæ­¥åˆ°äº‘ç«¯ã€‚");
            return true;
        } catch (error) {
            console.error("ä¿å­˜äº‘ç«¯æ•°æ®å¤±è´¥ã€‚", error);
            alert("æ•°æ®ä¿å­˜å¤±è´¥ï¼è¯·æ£€æŸ¥ JSONBin é…ç½®æˆ–ç½‘ç»œã€‚");
            return false;
        }
    }

    // --- æ ¸å¿ƒé€»è¾‘ ---
    function calculateOrderTotal(order) {
        return order.reduce((total, item) => total + (item.price * item.quantity), 0);
    }
    
    function calculateOrderSummary(order) {
        return order.reduce((summary, item) => {
            if (!summary[item.name]) {
                summary[item.name] = 0;
            }
            summary[item.name] += item.quantity;
            return summary;
        }, {});
    }

    function createDetailedOrderHTML(record, isClosed = false) {
        const orderClass = isClosed ? 'closed-order' : 'pending-order';
        const titleText = isClosed ? 'å·²ç»“ç®—è®¢å•' : 'æœªç»“ç®—è®¢å•';
        const total = record.total || calculateOrderTotal(record.items);
        const date = record.timestamp ? new Date(record.timestamp) : new Date();
        const dateTime = date.toLocaleString('zh-CN', { 
            year: 'numeric', month: '2-digit', day: '2-digit', 
            hour: '2-digit', minute: '2-digit' 
        });

        let detailsHTML = '<ul>';
        record.items.forEach(item => {
            detailsHTML += `
                <li>
                    <span>${item.name}</span>
                    <span>x ${item.quantity}</span>
                    <span>${(item.price * item.quantity).toLocaleString()} Ks</span>
                </li>
            `;
        });
        detailsHTML += '</ul>';

        return `
            <div class="${orderClass}">
                <div class="order-header">
                    <span>${titleText} - æ¡Œå· ${record.table}</span>
                    <span style="font-weight: normal; font-size: 0.8em; color: #777;">${dateTime}</span>
                </div>
                <div class="order-details">
                    ${detailsHTML}
                </div>
                <div class="order-header total-line">
                    <span>æ€»é‡‘é¢:</span>
                    <span>${total.toLocaleString()} Ks</span>
                </div>
            </div>
        `;
    }

    async function renderSummary() {
        await loadCloudData();

        const pendingOrdersListContainer = document.getElementById('pendingOrdersList');
        const closedOrdersListContainer = document.getElementById('closedOrdersList');
        
        // 1. æ¸²æŸ“æœªç»“ç®—è®¢å•
        let pendingOrdersHTML = '';
        const pendingTables = Array.from(tableOrdersMap.entries()).filter(([table, order]) => order && order.length > 0);
        
        pendingTables.forEach(([table, order]) => {
            const record = { table, items: order, total: calculateOrderTotal(order), timestamp: new Date().toISOString() };
            pendingOrdersHTML += createDetailedOrderHTML(record, false);
        });

        pendingOrdersListContainer.innerHTML = pendingOrdersHTML || '<div class="no-pending">æš‚æ— æœªç»“ç®—è®¢å•ã€‚</div>';
        
        // 2. æ¸²æŸ“å·²ç»“ç®—åˆ—è¡¨
        let closedOrdersListHTML = '';
        if (incomeData.closedOrders.length > 0) {
            const reversedOrders = [...incomeData.closedOrders].reverse(); 
            reversedOrders.forEach(record => {
                closedOrdersListHTML += createDetailedOrderHTML(record, true);
            });
            closedOrdersListContainer.innerHTML = closedOrdersListHTML;
        } else {
            closedOrdersListContainer.innerHTML = '<div class="no-closed">æš‚æ— å·²ç»“ç®—è®°å½•ã€‚</div>';
        }

        // 3. æ¸²æŸ“æ±‡æ€»é¢æ¿
        document.getElementById('totalIncome').textContent = incomeData.total.toLocaleString();
        document.getElementById('closedOrdersCount').textContent = incomeData.closedOrders.length;
        document.getElementById('pendingOrdersCount').textContent = pendingTables.length;
    }

    async function clearAllIncome() {
        if (confirm("è­¦å‘Šï¼æ‚¨ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰çš„æ”¶å…¥è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œä¸”ä¸ä¼šå½±å“å½“å‰æœªç»“ç®—çš„è®¢å•ã€‚")) {
            // æ¸…ç©ºæ•°æ®æ¨¡å‹
            globalCloudData.income_data = { total: 0, closedOrders: [] };
            incomeData = globalCloudData.income_data;

            const saved = await saveCloudData();
            if (saved) {
                renderSummary();
                alert("æ‰€æœ‰æ”¶å…¥è®°å½•å·²æ¸…ç©ºã€‚");
            }
        }
    }
    
    // --- é¡µé¢è·³è½¬ (FIXED: ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„æ–‡ä»¶å `index .html` - ä¿®å¤ç‚¹ï¼) ---
    function goToOrderingPage() {
        window.location.href = 'index .html'; 
    }

    document.addEventListener('DOMContentLoaded', async () => {
        await renderSummary();
        document.getElementById('loading-overlay').style.display = 'none';
    });
</script>

</body>
</html>