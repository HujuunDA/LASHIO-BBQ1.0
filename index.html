<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çƒ§çƒ¤è´¦å•è®¡ç®—å™¨10.19.17.00</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        /* ----------------------- CSS æ ·å¼åŒº - ç•Œé¢å¸ƒå±€å’Œç¾åŒ– ----------------------- */
        
        /* å¼•å…¥ç°ä»£å­—ä½“ */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');

        /* æ•´ä½“é¡µé¢æ ·å¼ */
        body {
            font-family: 'Poppins', 'Microsoft YaHei', 'SimHei', Arial, sans-serif;
            background: linear-gradient(135deg, #e36711, #ffbe91);
            padding: 20px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            color: #333;
            margin: 0;
        }

        /* å…³é”®ï¼šæ§åˆ¶ä¸åŒæ¡Œå­èœå•çš„æ˜¾ç¤ºçŠ¶æ€ */
        .table-menu-container {
            display: none;
        }
        .table-menu-container.active {
            display: block;
        }
        
        /* éšè—æ•°é‡è¾“å…¥æ¡†çš„ä¸Šä¸‹ç®­å¤´ */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        /* ----------------------- æ‰“å°æ ·å¼ (ç”¨äºå›¾ç‰‡è½¬æ¢æ—¶çš„æ ·å¼åŸºå‡†) ----------------------- */
           
        #print-area {
            /* å…è®¸ JS ä¸´æ—¶è®¾ç½®ä¸º 'block' */
            display: none; 
            
            /* æ¨¡æ‹Ÿæ”¶æ®çº¸å®½åº¦ï¼Œç¡®ä¿å›¾ç‰‡å°ºå¯¸åˆç† */
            width: 300px; 
            margin: 0; 
            padding: 10px;
            background-color: #fff; /* èƒŒæ™¯è‰²å¿…é¡»æ˜¯ç™½è‰²ï¼Œå¦åˆ™å›¾ç‰‡ä¼šé€æ˜ */
            font-family: 'Microsoft YaHei', 'SimHei', monospace;
            font-size: 14px;
            line-height:1.5;
            color: #000;
            box-sizing: border-box;
            position: absolute; /* é˜²æ­¢åœ¨é¡µé¢ä¸Šå ä½ */
            top: -9999px; /* ç§»åˆ°å±å¹•å¤– */
            left: -9999px;
            z-index: 9999;
            opacity: 0; /* é»˜è®¤éšè—ï¼Œç”¨äºé˜²æ­¢é—ªçƒ */
        }
        #print-area h2 {
            text-align: center;
            font-size: 20px;
            border-bottom: 2px solid #000;
            padding-bottom: 8px;
            margin-bottom: 10px;
            color: #000;
        }
        #print-area p {
            margin: 5px 0;
            font-size: 12px;
        }
        #print-area .print-item {
            display: flex;
            justify-content: space-between;
            margin-bottom:4px;
            font-size: 14px;
        }
        #print-area .print-total {
            font-size: 16px;
            font-weight: bold;
            text-align: center;
            border-top: 2px solid #000;
            padding-top: 10px;
            margin-top: 10px;
        }
        #print-area .print-info {
            font-size: 12px;
            margin-bottom: 10px;
        }
        #print-area hr {
            border: none;
            border-top: 1px dashed #000;
            margin: 10px 0;
        }
        
        /* ----------------------- é¡¶éƒ¨æ§åˆ¶æ æ ·å¼ ----------------------- */
        .top-bar {
            display: flex;
            justify-content: flex-end; /* ä¿®æ”¹: å°†æ‰€æœ‰å…ƒç´ é å³å¯¹é½ */
            align-items: center;
            margin-bottom: 20px;
            z-index: 100;
            flex-wrap: nowrap;
            gap: 10px; /* æ–°å¢: æ·»åŠ å…ƒç´ ä¹‹é—´çš„é—´è· */
        }
        /* è°ƒæ•´: å–æ¶ˆ .top-bar .dropdown çš„å·¦è¾¹è· */
        .top-bar .dropdown {
            margin-left: 0; 
        }

     /* å¤‡æ³¨è¾“å…¥æ¡†å®¹å™¨æ ·å¼ - **ä¿®æ”¹ä»¥åŒ¹é…æŒ‰é’®å°ºå¯¸** */
        .note-input-container {
            display: flex;
            align-items: center;
            margin-top: 5px; /* ã€æ–°å¢ã€‘ç•¥å¾®å‘ä¸‹ç§»åŠ¨å¤‡æ³¨æ¡† */
            /* ç»Ÿä¸€å¤§å°çš„å‚è€ƒå€¼ï¼šdropbtn é»˜è®¤é«˜åº¦æ˜¯ 12px*2(padding) + font-size */
            width: 150px; /* é»˜è®¤å®½åº¦ */
        }

        /* å¤‡æ³¨è¾“å…¥æ¡†æ ·å¼ - **ä¿®æ”¹ä»¥åŒ¹é…æŒ‰é’®å°ºå¯¸** */
        .note-input {
            padding: 12px 20px; /* åŒ¹é… .dropbtn çš„ padding */
            border: 1px solid #ff7e5f;
            border-radius: 8px;
            width: 100%;
            box-sizing: border-box;
            font-size: 14px; /* ç•¥å°äº dropbtn çš„ 16px */
            background-color: rgba(255, 255, 255, 0.8);
            border: none;
            height: 44px; /* ç»Ÿä¸€é«˜åº¦ï¼Œæ ¹æ® padding å’Œ font-size ä¼°ç®— */
        }

        /* ä¸‹æ‹‰èœå•åŸºç¡€æ ·å¼ */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        /* ä¸‹æ‹‰èœå•æŒ‰é’® - **ç»Ÿä¸€å¤§å°** */
        .dropbtn {
            background-color: #ff7e5f;
            color: white;
            padding: 12px 20px;
            font-size: 16px;
            border: none;
            cursor: pointer;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: background-color 0.2s, transform 0.2s;
            height: 44px; 
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* è®¾ç½®æŒ‰é’®å›¾æ ‡æ ·å¼ - **ç»Ÿä¸€å¤§å°** */
        #settings-dropbtn {
            font-size: 24px;
            width: 44px; 
            padding: 0; 
        }

        /* æŒ‰é’®æ‚¬åœæ•ˆæœ */
        .dropbtn:hover {
            background-color: #ff5e3a;
            transform: translateY(-2px);
        }

        /* ä¸‹æ‹‰èœå•å†…å®¹å®¹å™¨ */
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: rgba(255, 255, 255, 0.9);
            min-width: 100px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            right: 0;
            border-radius: 8px;
            overflow: hidden;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .dropdown-content a {
            color: #333;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            transition: background-color 0.2s;
            /* ã€ä¿®æ”¹ç‚¹ 1ã€‘é å³å¯¹é½ */
            text-align: right; 
        }

        .dropdown-content a:hover {
            background-color: rgba(255, 126, 95, 0.2);
        }

        /* ã€ä¿®æ”¹ç‚¹ 2ã€‘æ–°å¢ï¼šè‡ªå®šä¹‰æ·»åŠ æ¡Œå·é“¾æ¥æ ·å¼ */
        .add-table-link {
            color: #27ae60 !important; /* ç»¿è‰² */
            font-weight: bold;
        }

        /* é¼ æ ‡æ‚¬åœåœ¨ä¸‹æ‹‰èœå•æŒ‰é’®ä¸Šæ—¶æ˜¾ç¤ºå†…å®¹ */
        .dropdown:hover .dropdown-content {
            display: block;
        }
        
        /* ----------------------- ä¸»ä½“å†…å®¹åŒºæ ·å¼ ----------------------- */
        .main-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* å¡ç‰‡å®¹å™¨åŸºç¡€æ ·å¼ */
        .container, .bill-details-wrapper, .summary-total, .menu-editor-container, #summary-content {
            background-color: rgba(255, 255, 255, 0.4);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            backdrop-filter: blur(10px);
            flex-shrink: 0;
            overflow-x: hidden; 
        }
        
        /* è´¦å•æ˜ç»†å®¹å™¨ */
        .bill-details-wrapper {
            overflow-y: auto;
            flex-grow: 1;
            min-height: 100px;
        }

        /* æ ‡é¢˜æ ·å¼ */
        h2 {
            border-bottom: 2px solid #ffc3a0;
            padding-bottom: 15px;
            margin-top: 0;
            color: #f39c12;
            font-weight: 600;
        }
        
        /* ----------------------- ç§»åŠ¨ç«¯æ•´ä½“ä¼˜åŒ– - è‡ªé€‚åº”å¸ƒå±€ ----------------------- */
        @media (max-width: 767px) {
            
            /* (1) åŸºç¡€å¸ƒå±€å’Œé—´è·å‹ç¼© */
            body {
                padding: 8px; /* ç¼©å°è¾¹è· */
            }

            /* è°ƒæ•´å®¹å™¨å†…è¾¹è· */
            .container, .bill-details-wrapper, .summary-total, .menu-editor-container, #summary-content {
                padding: 12px; /* ç¼©å°å†…è¾¹è· */
            }

            /* (2) é¡¶éƒ¨æ§åˆ¶æ ä¼˜åŒ– */
            .top-bar {
                margin-bottom: 10px;
                flex-wrap: wrap; 
                gap: 5px; /* å‡å°é¡¶éƒ¨å…ƒç´ é—´è· */
            }
            .note-input-container {
                flex-grow: 1; 
                max-width: none; 
                width: auto;
                order: 1;
                margin-bottom: 5px; /* åº•éƒ¨ç•™ç™½ */
            }
            
            /* ç¡®ä¿å¤‡æ³¨è¾“å…¥æ¡†åœ¨å°å±å¹•ä¸Šä¿æŒä¸æŒ‰é’®ç»„ä¸€è‡´çš„é«˜åº¦ */
            .note-input {
                padding: 6px 8px; /* è¿›ä¸€æ­¥ç¼©å° padding */
                font-size: 13px;
                height: 32px; /* ç»Ÿä¸€æ›´å°çš„é«˜åº¦ */
            }
            
            /* å°å±æŒ‰é’®ç»Ÿä¸€å°ºå¯¸ */
            .dropbtn {
                padding: 6px 8px;
                font-size: 13px;
                height: 32px; /* ç»Ÿä¸€æ›´å°çš„é«˜åº¦ */
                order: 2; 
            }
            #settings-dropbtn {
                font-size: 18px;
                width: 32px;
                height: 32px;
            }
            .table-selector-dropdown {
                 order: 3;
            }
            .settings-dropdown {
                 order: 4;
            }
            
            /* (3) è´¦å•æ˜ç»†å‹ç¼© */
            #bill-details .item-row {
                margin-bottom: 5px; /* ç¼©å°è¡Œé—´è· */
                padding: 5px 0;
                font-size: 0.9em; /* ç•¥å¾®ç¼©å°å­—ä½“ */
            }
            
            /* è´¦å•æ€»è®¡å‹ç¼© */
            .total {
                font-size: 1.5em; 
            }
            
            /* ç»“ç®—æŒ‰é’®å‹ç¼© */
            .action-buttons button {
                 padding: 8px 15px;
                 font-size: 0.9em;
            }
            
            /* (4) èœå•å¡ç‰‡ä¼˜åŒ– */
            .item {
                padding: 8px; /* å‡å°‘å¡ç‰‡å†…è¾¹è· */
            }
            
            .item-image {
                width: 60px; /* è¿›ä¸€æ­¥ç¼©å°å›¾ç‰‡ */
                height: 60px;
                margin-bottom: 5px;
            }
            .item-info h3 {
                font-size: 0.85em; /* ç¼©å°æ ‡é¢˜ */
            }
            .item-controls button {
                width: 18px;
                height: 18px;
                font-size: 0.8em;
            }
            .item-controls input {
                width: 20px;
                font-size: 0.8em;
            }
            
            /* **æ ¸å¿ƒä¿®æ”¹ï¼šç§»é™¤å¼ºåˆ¶ç¼©æ”¾**
               ç°åœ¨ï¼Œèœå•é¡¹ (`.item` çš„ `calc(50% - 7.5px)`) å°†è‡ªè¡Œé€‚åº”å±å¹•å®½åº¦ã€‚
            */
            #menu-area, 
            .menu-editor-container, 
            #summary-content { 
                /* ç§»é™¤ transform: scale(0.8); å’Œç›¸å…³çš„ width/margin è¦†ç›–ï¼Œ
                   è®©å…ƒç´ è‡ªç„¶é€‚åº”æ‰‹æœºå±å¹•çš„å®½åº¦ã€‚
                */
            }
        }
        /* ----------------------- èœå“åˆ†ç±»æ ·å¼ ----------------------- */
        .category-section {
            margin-top: 25px;
            border: 1px solid #ffc3a0;
            border-radius: 10px;
            overflow: hidden;
            background-color: rgba(255, 255, 255, 0.7);
        }

        .category-header {
            background-color: #ff7e5f;
            color: white;
            padding: 15px 20px;
            font-size: 1.3em;
            font-weight: 600;
            cursor: default;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .category-content {
            padding: 10px;
            display: flex; 
            flex-wrap: wrap; 
            gap: 15px; 
        }

        /* Hide the first top margin to prevent double spacing */
        .category-section:first-child {
            margin-top: 0;
        }

        /* ----------------------- èœå“é¡¹æ ·å¼ (æ­£æ–¹å½¢å¡ç‰‡) ----------------------- */
        
        .item {
            /* é»˜è®¤ä¸¤åˆ—ï¼Œå‡å» gap */
            flex: 1 1 calc(50% - 7.5px); 
            max-width: calc(50% - 7.5px);

            /* å†…éƒ¨å¸ƒå±€æ”¹ä¸ºå‚ç›´ï¼Œä»¥ä¾¿å›¾ç‰‡/ä¿¡æ¯/æ•°é‡å †å ï¼Œå½¢æˆæ–¹å—æ„Ÿ */
            flex-direction: column; 
            align-items: center; /* å±…ä¸­å¯¹é½ */
            text-align: center;
            
            padding: 10px; 
            background-color: rgba(255, 255, 255, 0.6);
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            backdrop-filter: blur(10px);
            cursor: pointer;
            box-sizing: border-box; /* ç¡®ä¿ padding åŒ…å«åœ¨å®½åº¦å†… */
        }

        @media (min-width: 768px) {
            .item {
                flex: 1 1 calc(33.333% - 10px); /* æ¡Œé¢ç«¯ä¸‰åˆ— */
                max-width: calc(33.333% - 10px);
            }
        }
        @media (min-width: 1024px) {
            .item {
                flex: 1 1 calc(25% - 11.25px); /* å®½å±å››åˆ— */
                max-width: calc(25% - 11.25px);
            }
        }

        .item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .item-image {
            width: 90px; /* å¢åŠ å°ºå¯¸ï¼Œå¢å¼ºæ–¹å—æ„Ÿ */
            height: 90px;
            object-fit: cover;
            border-radius: 12px;
            margin-right: 0; 
            margin-bottom: 10px;
            border: 2px solid #ff7e5f;
            pointer-events: none;
        }

        .item-info {
            flex-grow: 0;
            margin-bottom: 10px;
            pointer-events: none;
            min-width: 0;
        }
        
        .item-info h3 {
            font-size: 1em;
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .item-info p {
            font-size: 0.9em;
            margin: 0;
        }

        /* æ•°é‡æ§åˆ¶åŒºï¼šæ”¹ä¸ºæ°´å¹³æ’åˆ—ï¼Œæ›´ç´§å‡‘ */
        .item-controls {
            display: flex;
            flex-direction: row; /* æ°´å¹³æ’åˆ— */
            align-items: center;
            justify-content: center; /* ç¡®ä¿åŠ å‡æŒ‰é’®ç»„å±…ä¸­æ˜¾ç¤º */
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            padding: 3px;
            backdrop-filter: blur(10px);
            pointer-events: auto;
        }

        .item-controls input {
            width: 30px; 
            text-align: center;
            margin: 0 5px; 
            border: none;
            background-color: transparent;
            font-size: 1em;
            font-weight: 600;
        }
        
        .item-controls button {
            background-color: #ff7e5f;
            color: white;
            border: none;
            padding: 0;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1em;
            width: 25px; 
            height: 25px;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.2s, transform 0.2s;
        }

        .item-controls button:hover {
            background-color: #ff5e3a;
            transform: scale(1.1);
        }

        /* ----------------------- è´¦å•æ˜ç»†æ ·å¼ ----------------------- */
        /* è´¦å•æ˜ç»†ä¸­çš„è¡Œæ ·å¼ (æ€§èƒ½ä¼˜åŒ–ï¼šå°†item-rowç”¨äºJSæŸ¥æ‰¾) */
        #bill-details .item-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px dashed #ffc3a0;
        }
        
        #bill-details .item-total {
            min-width: 100px;
            text-align: right;
            font-weight: 600;
        }
        
        /* æ€»è®¡é‡‘é¢æ ·å¼ */
        .total {
            font-size: 1.8em;
            font-weight: 700;
            text-align: right;
            color: #f39c12;
            padding-top: 15px;
        }

        /* å¤‡æ³¨æ˜¾ç¤ºåŒºæ ·å¼ (æ–°å¢) */
        #current-note-display {
            text-align: right; 
            margin-bottom: 10px; 
            font-size: 1.1em; 
            color: #555;
            min-height: 25px; /* ç¡®ä¿å ä½ */
        }
        
        .action-buttons {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        
        /* ç»“ç®—æŒ‰é’®æ ·å¼ */
        .action-buttons button {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 1em;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .action-buttons button:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
        }

        /* ----------------------- èœå•ç¼–è¾‘æ¨¡å¼æ ·å¼ ----------------------- */
        .menu-editor-container {
            background-color: rgba(255, 255, 255, 0.4);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            backdrop-filter: blur(10px);
        }
        
        .menu-editor-container table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
            margin-bottom: 20px;
        }
        
        .menu-editor-container th,
        .menu-editor-container td {
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .menu-editor-container th {
            background-color: rgba(255, 195, 160, 0.3);
        }
        
        .menu-editor-container input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
        }
        
        .menu-editor-container button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
        }
        
        .menu-editor-container button:hover {
            background-color: #2980b9;
        }
        
        .add-new {
            background-color: #27ae60 !important;
            padding: 10px 20px !important;
        }
        
        .add-new:hover {
            background-color: #219653 !important;
        }

        /* ----------------------- æ±‡æ€»æ¨¡å¼æ ·å¼ ----------------------- */
        #summary-content {
            background-color: rgba(255, 255, 255, 0.4);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            backdrop-filter: blur(10px);
        }
        
        .daily-summary-section {
            margin-bottom: 20px;
            padding: 15px;
            background-color: rgba(255, 255, 255, 0.6);
            border-radius: 8px;
        }
        
        .daily-summary-section h3 {
            color: #f39c12;
            margin-top: 0;
        }
        
        .daily-summary-section .daily-total {
            font-weight: bold;
            color: #e74c3c;
        }
        
        #grand-total {
            font-size: 1.5em;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            color: #f39c12;
        }
        
        .summary-action-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        .summary-action-buttons button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .summary-action-buttons button.export {
            background-color: #27ae60;
        }
        
        .summary-action-buttons button:hover {
            opacity: 0.9;
        }

        /* æ–°å¢ï¼šè®¢å•è¯¦æƒ…æ ·å¼ */
        .order-details {
            margin-top: 10px;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 4px;
        }

        .order-details p {
            margin: 5px 0;
        }

        .order-items {
            list-style-type: none;
            padding: 0;
        }

        .order-items li {
            margin-bottom: 5px;
        }
        
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="note-input-container">
            <input type="text" id="order-note-input" placeholder="è¾“å…¥å¤‡æ³¨..." class="note-input">
        </div>

        <div class="dropdown table-selector-dropdown">
            <button id="table-selector-dropbtn" class="dropbtn table-selector-dropbtn">æ¡Œå·</button>
            <div id="table-dropdown-content" class="dropdown-content">
                </div>
        </div>

        <div class="dropdown settings-dropdown">
            <button id="settings-dropbtn" class="dropbtn">&#9881;</button>
            <div id="action-dropdown" class="dropdown-content">
                <a href="#" id="summary-link" onclick="toggleSummaryMode()">æŸ¥çœ‹æ±‡æ€»</a>
                <a href="#" id="edit-link" onclick="toggleEditMode()">ç¼–è¾‘èœå•</a>
            </div>
        </div>
    </div>

    <div id="main-content" class="main-container">
        <div class="container">
            <div id="menu-area"></div> 
        </div>
        
        <div class="bill-details-wrapper">
            <h2>è´¦å•æ˜ç»†</h2>
            <div id="bill-details"></div>
        </div>
        
        <div class="summary-total">
            <div id="current-note-display"></div>
            <hr>
            <div class="total">
                <p>æ€»è®¡ï¼š<span id="total-price">0.00</span> Ks</p>
            </div>
            <div class="action-buttons">
                <button id="settle-button" onclick="settleAndClear()">ç»“ç®—</button>
            </div>
        </div>
    </div>
    
    <div id="edit-content" class="menu-editor-container" style="display: none;">
        <h2>èœå•ç¼–è¾‘</h2>
        <table>
            <thead>
                <tr>
                    <th>åç§°</th>
                    <th>ä»·æ ¼</th>
                    <th>åˆ†ç±»</th> <th>å›¾ç‰‡</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="menu-editor-body">
                </tbody>
        </table>
        <button class="add-new" onclick="addNewItem()">æ·»åŠ æ–°èœå“</button>
        <button onclick="saveAllMenuItems()" style="background-color: #3498db; margin-left: 10px;">ä¿å­˜æ‰€æœ‰</button>
        <button onclick="toggleEditMode()" style="background-color: #95a5a6; margin-left: 10px;">è¿”å›ç‚¹å•</button>
    </div>

    <div id="summary-content" style="display: none;">
        <h2>èµ„é‡‘æ±‡æ€»ç®¡ç†</h2>
        
        <div id="summary-nav" style="display: flex; justify-content: center; gap: 15px; margin-bottom: 20px;">
            <button onclick="showSummaryView('profit-loss')" style="padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer; background-color: #f39c12; color: white; font-weight: bold; opacity: 1.0;">æŸç›Šæ±‡æ€»</button>
            <button onclick="showSummaryView('income')" style="padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer; background-color: #27ae60; color: white; font-weight: bold; opacity: 0.7;">æ”¶å…¥ç®¡ç†</button>
            <button onclick="showSummaryView('expense')" style="padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer; background-color: #e74c3c; color: white; font-weight: bold; opacity: 0.7;">æ”¯å‡ºç®¡ç†</button>
        </div>

        <div id="profit-loss-view" style="display: block;">
            <h3 style="color: #f39c12; border-bottom: 1px solid #ffc3a0; padding-bottom: 10px;">æ¯æ—¥/æ¯æœˆæŸç›Šæ±‡æ€»</h3>
            <div id="summary-container"></div>
            <div id="grand-total">æ€»æŸç›Š: 0 Ks</div>
        </div>
        
        <div id="income-view" style="display: none;">
            <h3 style="color: #27ae60; border-bottom: 1px solid #ffc3a0; padding-bottom: 10px;">æ·»åŠ æ–°çš„å…¶ä»–æ”¶å…¥</h3>
            <div style="margin-bottom: 20px; display: flex; align-items: center; flex-wrap: wrap; gap: 10px;">
                <input type="date" id="income-date" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <input type="text" id="income-description" placeholder="æ”¶å…¥æè¿°" style="width: 150px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <input type="number" id="income-amount" placeholder="é‡‘é¢ (Ks)" style="width: 100px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <button onclick="addIncome()" style="background-color: #27ae60; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">è®°å½•æ”¶å…¥</button>
            </div>
            <h3 style="color: #27ae60; border-bottom: 1px dashed #ffc3a0; padding-bottom: 10px;">å†å²æ”¶å…¥è®°å½• (å«é”€å”®è®¢å•)</h3>
            <div id="income-list" style="margin-top: 20px;"></div>
        </div>
        
        <div id="expense-view" style="display: none;">
            <h3 style="color: #e74c3c; border-bottom: 1px solid #ffc3a0; padding-bottom: 10px;">æ·»åŠ æ–°çš„æ”¯å‡º</h3>
            <div style="margin-bottom: 20px; display: flex; align-items: center; flex-wrap: wrap; gap: 10px;">
                <input type="date" id="expense-date" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;"> 
                <input type="text" id="expense-description" placeholder="æ”¯å‡ºæè¿°" style="width: 150px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <input type="number" id="expense-amount" placeholder="é‡‘é¢ (Ks)" style="width: 100px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <button onclick="addExpense()" style="background-color: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">è®°å½•æ”¯å‡º</button>
            </div>
            <h3 style="color: #e74c3c; border-bottom: 1px dashed #ffc3a0; padding-bottom: 10px;">å†å²æ”¯å‡ºè®°å½•</h3>
            <div id="expense-list" style="margin-top: 20px;"></div>
        </div>


        <div class="summary-action-buttons">
            <button class="export" onclick="exportToExcel()">å¯¼å‡ºå†å²è´¦å•</button>
            <button onclick="clearAllHistory()">æ¸…ç©ºæ‰€æœ‰å†å²è´¦å•</button>
            <button onclick="toggleSummaryMode()">è¿”å›ç‚¹å•</button>
        </div>
    </div>

    <div id="print-area"></div>

    <script>
        // --- IndexedDB æ•°æ®å­˜å‚¨é…ç½® ---
        const dbName = 'bbq_pos_db';
        const dbVersion = 1;
        const menuStoreName = 'menu_items';
        let db;
        
        // --- å…¨å±€å˜é‡å’Œå…ƒç´ å¼•ç”¨ ---
        let menuItems = [];
        let activeTables = []; 
        let currentTable = 1;
        
        let isEditMode = false;
        let isSummaryMode = false;

        // è·å– DOM å…ƒç´ çš„å¼•ç”¨
        const mainContent = document.getElementById('main-content');
        const editContent = document.getElementById('edit-content');
        const summaryContent = document.getElementById('summary-content');
        const menuArea = document.getElementById('menu-area');
        const billDetails = document.getElementById('bill-details');
        const totalPriceSpan = document.getElementById('total-price');
        const settleButton = document.getElementById('settle-button');
        const tableSelectorDropbtn = document.getElementById('table-selector-dropbtn');
        const tableDropdownContent = document.getElementById('table-dropdown-content');
        const editLink = document.getElementById('edit-link');
        const summaryLink = document.getElementById('summary-link');
        const printArea = document.getElementById('print-area'); 
        
        const orderNoteInput = document.getElementById('order-note-input');
        const currentNoteDisplay = document.getElementById('current-note-display'); 
        
        const defaultPlaceholder = "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNzAiIGhlaWdodD0iNzAiIHZpZXdCb3g9IjAgMCA3MCA3MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMuLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSI3MCIgaGVpZ2h0PSI3MCIgcng9IjgiIGZpbGw9IiNGRjNBNTAiLz4KPHBhdGggZD09Ik0zNSAzNUwzNSAyNUwzNSA0NU00NSAzNUwyNSAzNSIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiLz4KPC9zdmc+Cg==";

        let audioContext;

        // --- ğŸ”´ğŸ”´ğŸ”´ Firebase äº‘åŒæ­¥é…ç½® (å¿…é¡»æ›¿æ¢) ğŸ”´ğŸ”´ğŸ”´ ---
        // !!! æ‚¨å¿…é¡»å°†ä»¥ä¸‹é…ç½®ä¿¡æ¯æ›¿æ¢ä¸ºæ‚¨è‡ªå·±çš„ Firebase é¡¹ç›®ä¿¡æ¯ï¼Œå¦åˆ™äº‘åŒæ­¥åŠŸèƒ½å°†æ— æ³•å·¥ä½œ !!!
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY_HERE", // <-- ğŸ”´ æ›¿æ¢è¿™é‡Œ
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com", // <-- ğŸ”´ æ›¿æ¢è¿™é‡Œ
            databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com", // <-- ğŸ”´ æ›¿æ¢è¿™é‡Œ
            projectId: "YOUR_PROJECT_ID", // <-- ğŸ”´ æ›¿æ¢è¿™é‡Œ
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        
        let database = null; // é»˜è®¤ä¸º nullï¼Œå¦‚æœåˆå§‹åŒ–å¤±è´¥åˆ™ä¿æŒæœ¬åœ°æ¨¡å¼
        let syncedData = {
            tables: {},       // { '1': { order: {}, note: '' }, ... }
            history: [],
            income: [],
            expense: [],
            activeTables: [1], // é»˜è®¤
            menuItems: [],
        };
        let dataLoadedFromFirebase = false; 

        // ----------------------- ã€æ–°å¢ã€‘Firebase äº‘åŒæ­¥é€»è¾‘ -----------------------

        /** * åˆå§‹åŒ– Firebase å¹¶å°è¯•å»ºç«‹è¿æ¥ */
        function initializeFirebase() {
             if (firebaseConfig.apiKey === "YOUR_API_KEY_HERE") {
                 console.warn("Firebase é…ç½®æœªè®¾ç½®ï¼Œæ•°æ®å°†ä»…å­˜å‚¨åœ¨æœ¬åœ° localStorage/IndexedDBã€‚");
                 database = null;
                 return;
             }
             try {
                 if (typeof firebase !== 'undefined' && !firebase.apps.length) {
                     firebase.initializeApp(firebaseConfig);
                 }
                 if (typeof firebase !== 'undefined') {
                     database = firebase.database();
                     setupFirebaseListeners();
                     console.log("Firebase åˆå§‹åŒ–æˆåŠŸï¼Œæ­£åœ¨ç­‰å¾…æ•°æ®åŒæ­¥...");
                 } else {
                      console.error("Firebase SDK æœªåŠ è½½ã€‚");
                      database = null;
                 }
             } catch (e) {
                 console.error("Firebase åˆå§‹åŒ–å¤±è´¥ï¼Œå°†ä½¿ç”¨æœ¬åœ°å­˜å‚¨:", e);
                 database = null;
             }
        }

        /** * è®¾ç½® Firebase Realtime Database ç›‘å¬å™¨ */
        function setupFirebaseListeners() {
            if (!database) return;

            database.ref('bbq_pos_data').on('value', (snapshot) => {
                const data = snapshot.val();
                
                // 1. æ›´æ–°æœ¬åœ°å†…å­˜ syncedData
                if (data) {
                    syncedData.tables = data.tables || {};
                    syncedData.history = data.history || [];
                    syncedData.income = data.income || [];
                    syncedData.expense = data.expense || [];
                    syncedData.activeTables = data.activeTables || [1]; 
                    syncedData.menuItems = data.menuItems || []; 

                    // 2. èœå•åŒæ­¥: äº‘ç«¯èœå•ä¼˜å…ˆæ›´æ–°æœ¬åœ°å†…å­˜èœå•
                    if (syncedData.menuItems.length > 0) {
                        menuItems = syncedData.menuItems;
                        updateIndexedDBMenuFromCloud(); // å¼‚æ­¥æ›´æ–° IndexedDB ç¼“å­˜
                        if (dataLoadedFromFirebase) {
                            renderAllMenus(); // èœå•å˜æ›´åé‡æ–°æ¸²æŸ“ UI
                        }
                    }

                    // 3. æ´»è·ƒæ¡Œå·åŒæ­¥
                    // å¦‚æœäº‘ç«¯æœ‰æ›´"æ–°"çš„ activeTablesï¼Œä»¥äº‘ç«¯ä¸ºå‡†
                    if (syncedData.activeTables && JSON.stringify(syncedData.activeTables) !== JSON.stringify(activeTables)) {
                        activeTables = syncedData.activeTables;
                        saveActiveTablesLocally(); // å¼ºåˆ¶æ›´æ–°æœ¬åœ° localStorage
                        generateTableSelectors();
                        
                        // ç¡®ä¿å½“å‰æ¡Œå·æœ‰æ•ˆ
                        if (!activeTables.includes(currentTable) && activeTables.length > 0) {
                            switchTable(activeTables[0]);
                        } else {
                            updateBill();
                        }
                    }
                    
                    dataLoadedFromFirebase = true;
                    // é¦–æ¬¡åŠ è½½åï¼Œåˆ·æ–° UI
                    if (isInitialized) {
                       updateBill();
                       updateSummaryUI();
                    }

                } else if (!dataLoadedFromFirebase) {
                    // é¦–æ¬¡åŠ è½½ï¼Œä½†äº‘ç«¯æ•°æ®ä¸ºç©ºï¼Œå°è¯•å°†æœ¬åœ°åˆå§‹åŒ–æ•°æ®æ¨é€åˆ°äº‘ç«¯
                    dataLoadedFromFirebase = true; 
                    console.log("äº‘ç«¯æ•°æ®ä¸ºç©ºï¼Œæ¨é€æœ¬åœ°åˆå§‹çŠ¶æ€ã€‚");
                    saveAllDataToFirebase();
                }
            }, (errorObject) => {
                console.log('Firebase è¯»å–å¤±è´¥: ' + errorObject.name);
            });
        }
        
        /** * å°†æ‰€æœ‰å…³é”®æ•°æ®ä¿å­˜åˆ° Firebase */
        function saveAllDataToFirebase(path = null, value = null) {
             if (!database) return;

             // 1. å¦‚æœæœ‰ç‰¹å®šè·¯å¾„æ›´æ–°ï¼Œåˆ™åªæ›´æ–°ç‰¹å®šè·¯å¾„
             if (path && value !== null) {
                 database.ref(`bbq_pos_data/${path}`).set(value)
                     .catch(error => console.error(`ä¿å­˜ ${path} åˆ°äº‘ç«¯å¤±è´¥:`, error));
                 return;
             }
             
             // 2. å¦åˆ™ï¼Œå¼ºåˆ¶æ¨é€æ•´ä¸ªçŠ¶æ€ (ç”¨äºåˆå§‹åŒ–æˆ–é‡å¤§å˜æ›´)
             const dataToSync = {
                 tables: syncedData.tables,
                 history: syncedData.history,
                 income: syncedData.income,
                 expense: syncedData.expense,
                 activeTables: activeTables,
                 menuItems: menuItems,
                 menuLastUpdated: Date.now()
             };

             database.ref('bbq_pos_data').set(dataToSync)
                 .then(() => console.log("æ•°æ®å·²åŒæ­¥åˆ°äº‘ç«¯ã€‚"))
                 .catch(error => console.error("æ•°æ®åŒæ­¥åˆ°äº‘ç«¯å¤±è´¥:", error));
        }
        
        /** * ä»äº‘ç«¯èœå•æ›´æ–°æœ¬åœ° IndexedDB (ç”¨äºæœ¬åœ°ç¼“å­˜) */
        async function updateIndexedDBMenuFromCloud() {
             try {
                 if (!db) await openDB();
                 const transaction = db.transaction([menuStoreName], 'readwrite');
                 const store = transaction.objectStore(menuStoreName);
                 
                 // æ¸…ç©ºæœ¬åœ° IndexedDB
                 await new Promise((resolve, reject) => {
                     const clearRequest = store.clear();
                     clearRequest.onsuccess = resolve;
                     clearRequest.onerror = reject;
                 });

                 // å†™å…¥æ–°çš„äº‘ç«¯èœå•
                 for (const item of menuItems) {
                    if (!item.id) item.id = Date.now() + Math.random(); 
                    store.add(item); 
                 }
                 console.log("æœ¬åœ°èœå•å·²ä»äº‘ç«¯åŒæ­¥æ›´æ–°ã€‚");

             } catch (error) {
                 console.error("æ›´æ–°æœ¬åœ° IndexedDB èœå•å¤±è´¥:", error);
             }
        }


        // --- IndexedDB æ•°æ®åº“æ“ä½œå‡½æ•° (ä¿æŒåŸæœ‰é€»è¾‘ï¼Œä½†èœå•å†™å…¥ä¼šè§¦å‘äº‘åŒæ­¥) ---

        /** * æ‰“å¼€æˆ–åˆ›å»º IndexedDB æ•°æ®åº“ */
        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(dbName, dbVersion);

                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains('menu_items')) {
                        db.createObjectStore('menu_items', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('orders_history')) {
                         db.createObjectStore('orders_history', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('income_store')) {
                         db.createObjectStore('income_store', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('expense_store')) {
                         db.createObjectStore('expense_store', { keyPath: 'id', autoIncrement: true });
                    }
                };

                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve(db);
                };
                request.onerror = (event) => {
                    console.error("IndexedDB é”™è¯¯:", event.target.error);
                    reject(event.target.error);
                };
            });
        }

        /** * ä»æ•°æ®åº“è·å–æ‰€æœ‰èœå•é¡¹ (æœ¬åœ° IndexedDB) */
        async function getMenuItems() {
            if (!db) await openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([menuStoreName], 'readonly');
                const store = transaction.objectStore(menuStoreName);
                const request = store.getAll();
                request.onsuccess = (event) => resolve(event.target.result);
                request.onerror = (event) => reject(event.target.error);
            });
        }

        /** * ä¿å­˜èœå•é¡¹åˆ°æ•°æ®åº“ (IndexedDB å’Œ Firebase) */
        async function saveMenuItemToDB(item) {
            if (!db) await openDB();
            
            // 1. æ›´æ–°æœ¬åœ° IndexedDB
            const resultId = await new Promise((resolve, reject) => {
                const transaction = db.transaction([menuStoreName], 'readwrite');
                const store = transaction.objectStore(menuStoreName);
                if (!item.id) item.id = Date.now() + Math.random(); 
                const request = store.put(item);
                request.onsuccess = () => resolve(item.id); 
                request.onerror = (event) => reject(event.target.error);
            });
            
            // 2. æ›´æ–°å†…å­˜ä¸­çš„ menuItems 
            let existingIndex = menuItems.findIndex(i => i.id === item.id);
            if (existingIndex > -1) {
                menuItems[existingIndex] = item;
            } else {
                menuItems.push(item);
            }

            // 3. åŒæ­¥åˆ° Firebase (æ•´ä¸ªèœå•)
            saveAllDataToFirebase('menuItems', menuItems);

            return resultId;
        }

        /** * ä»æ•°æ®åº“åˆ é™¤èœå•é¡¹ (IndexedDB å’Œ Firebase) */
        async function deleteMenuItemFromDB(id) {
            if (!db) await openDB();
            
            // 1. æ›´æ–°æœ¬åœ° IndexedDB
            await new Promise((resolve, reject) => {
                const transaction = db.transaction([menuStoreName], 'readwrite');
                const store = transaction.objectStore(menuStoreName);
                const request = store.delete(id);
                request.onsuccess = () => resolve();
                request.onerror = (event) => reject(event.target.error);
            });
            
            // 2. æ›´æ–°å†…å­˜ä¸­çš„ menuItems
            menuItems = menuItems.filter(i => i.id !== id);

            // 3. åŒæ­¥åˆ° Firebase (æ•´ä¸ªèœå•)
            saveAllDataToFirebase('menuItems', menuItems);
        }

        /** * åˆå§‹åŒ–é»˜è®¤èœå•é¡¹ */
        async function initializeDefaultMenu() {
            const defaultMenu = [
                { name: "ç¾Šè‚‰ä¸²", price: 2000, category: "è‚‰ç±»", id: 1 },
                { name: "ç‰›è‚‰ä¸²", price: 2500, category: "è‚‰ç±»", id: 2 },
                { name: "é¸¡ç¿…", price: 3000, category: "è‚‰ç±»", id: 3 },
                { name: "çƒ¤é±¼", price: 5000, category: "æµ·é²œ/æ°´äº§", id: 4 },
                { name: "çƒ¤è™¾", price: 4000, category: "æµ·é²œ/æ°´äº§", id: 5 },
                { name: "çƒ¤ç‰ç±³", price: 1500, category: "ç´ èœ", id: 6 },
                { name: "çƒ¤èŒ„å­", price: 2000, category: "ç´ èœ", id: 7 },
                { name: "å•¤é…’", price: 3500, category: "é…’æ°´/é¥®æ–™", id: 8 },
                { name: "å¯ä¹", price: 1000, category: "é…’æ°´/é¥®æ–™", id: 9 },
                { name: "çƒ¤éŸ­èœ", price: 1500, category: "ç´ èœ", id: 10 }
            ]; 
            
            if (!db) await openDB();
            const transaction = db.transaction([menuStoreName], 'readwrite');
            const store = transaction.objectStore(menuStoreName);
            
            for (const item of defaultMenu) {
                store.put(item);
            }
            
            menuItems = defaultMenu;
            
            saveAllDataToFirebase('menuItems', menuItems); // é»˜è®¤èœå•ä¹ŸåŒæ­¥
            
            return defaultMenu;
        } 

        /** * åŠ è½½èœå•é¡¹ (ä» IndexedDB ä¼˜å…ˆï¼Œå¤±è´¥åˆ™ä½¿ç”¨é»˜è®¤å€¼) */
        async function loadMenuItems() {
             // 1. ä¼˜å…ˆä»å†…å­˜åŠ è½½ (å†…å­˜å¯èƒ½å·²è¢« Firebase å¡«å……)
             if (menuItems.length > 0) {
                 return menuItems;
             }
             
             // 2. å°è¯•ä» IndexedDB åŠ è½½
             let items = [];
             try {
                 items = await getMenuItems();
             } catch (error) {
                 console.error("åŠ è½½æœ¬åœ°èœå•é¡¹å¤±è´¥:", error);
             }
             
            // 3. å¦‚æœ IndexedDB ä¸ä¸ºç©ºï¼Œä½¿ç”¨å®ƒ
            if (items.length > 0) {
                menuItems = items;
                return menuItems;
            }
            
            // 4. å¦‚æœéƒ½ä¸ºç©ºï¼Œåˆå§‹åŒ–é»˜è®¤èœå•
            menuItems = await initializeDefaultMenu();
            return menuItems;
        }
        
        // --- è¾…åŠ©å·¥å…·å‡½æ•° (æœªä¿®æ”¹) --- 
        function playSound() { 
            // ... (playSound å‡½æ•°ä»£ç æœªæ”¹åŠ¨)
        } 
        
        function vibrateDevice() { 
            // ... (vibrateDevice å‡½æ•°ä»£ç æœªæ”¹åŠ¨)
        } 
        
        function getTodayDateString() { 
            // ... (getTodayDateString å‡½æ•°ä»£ç æœªæ”¹åŠ¨)
        } 

        function calculateTotal(orderData) { 
            let total = 0; 
            for (const itemName in orderData) { 
                const quantity = orderData[itemName]; 
                const item = menuItems.find(i => i.name === itemName); 
                if (item) { 
                    total += item.price * quantity; 
                } 
            } 
            return total; 
        } 
        
        function formatPrice(price) { 
            const num = parseFloat(price); 
            if (isNaN(num)) return '0.00'; 
            return num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ","); 
        } 

        // ----------------------- LocalStorage/Firebase Hybrid æ•°æ®è®¿é—® -----------------------
        
        // **æ³¨æ„ï¼šæ‰€æœ‰å¯¹è®¢å•ã€å†å²è®°å½•ã€æ”¶å…¥ã€æ”¯å‡ºçš„è®¿é—®éƒ½é€šè¿‡ syncedData å¯¹è±¡è¿›è¡Œï¼Œ
        // å¹¶é€šè¿‡ saveAllDataToFirebase è¿›è¡Œäº‘ç«¯åŒæ­¥ã€‚Local Storage åªç”¨äº activeTables å’Œ lastTableã€‚**

        /** * ä» syncedData ä¸­åŠ è½½æŒ‡å®šæ¡Œå­çš„å½“å‰è®¢å• */
        function loadCurrentOrder(tableNumber) {
            const tableKey = String(tableNumber);
            return (syncedData.tables[tableKey] && syncedData.tables[tableKey].order) ? syncedData.tables[tableKey].order : {};
        }

        /** * ä¿å­˜è®¢å•åˆ° syncedData å¹¶åŒæ­¥åˆ°äº‘ç«¯ */
        function saveCurrentOrder(tableNumber, order) {
            const tableKey = String(tableNumber);
            if (!syncedData.tables[tableKey]) {
                syncedData.tables[tableKey] = { order: {}, note: '' };
            }
            syncedData.tables[tableKey].order = order;
            // ä»…ä¿å­˜ tables èŠ‚ç‚¹
            saveAllDataToFirebase('tables', syncedData.tables); 
        }

        /** * ä» syncedData ä¸­åŠ è½½æŒ‡å®šæ¡Œå­çš„å¤‡æ³¨ */
        function loadTableNote(tableNumber) {
            const tableKey = String(tableNumber);
            // ä¼˜å…ˆä»å¤‡æ³¨è¾“å…¥æ¡†è¯»å–ï¼Œå…¶æ¬¡ä»å†…å­˜
            return orderNoteInput.value || (syncedData.tables[tableKey] && syncedData.tables[tableKey].note) || '';
        }

        /** * ä¿å­˜å¤‡æ³¨åˆ° syncedData å¹¶åŒæ­¥åˆ°äº‘ç«¯ */
        function saveTableNote(tableNumber, note) {
            const tableKey = String(tableNumber);
            if (!syncedData.tables[tableKey]) {
                syncedData.tables[tableKey] = { order: {}, note: '' };
            }
            syncedData.tables[tableKey].note = note;
            // ä»…ä¿å­˜ tables èŠ‚ç‚¹
            saveAllDataToFirebase('tables', syncedData.tables); 
        }
        
        /** * ã€ä¿®æ­£ã€‘ä» LocalStorage åŠ è½½æ´»è·ƒæ¡Œå·åˆ—è¡¨ (å¢å¼ºæœ¬åœ°æŒä¹…æ€§) */
        function loadActiveTablesLocally() {
            const savedTables = localStorage.getItem('bbq_active_tables');
            let tables = savedTables ? JSON.parse(savedTables) : [1];

            tables = [...new Set(tables)].filter(t => t !== null && t !== undefined);
            if (tables.length === 0) {
                tables = [1];
            }
            
            tables.sort((a, b) => {
                const aIsNum = typeof a === 'number' || (typeof a === 'string' && !isNaN(parseInt(a)));
                const bIsNum = typeof b === 'number' || (typeof b === 'string' && !isNaN(parseInt(b)));
                if (aIsNum && bIsNum) {
                    return (parseInt(a) || Infinity) - (parseInt(b) || Infinity);
                } else if (aIsNum) {
                    return -1; 
                } else if (bIsNum) {
                    return 1; 
                } else {
                    return String(a).localeCompare(String(b)); 
                }
            });

            return tables;
        }

        /** * ã€ä¿®æ­£ã€‘ä¿å­˜æ´»è·ƒæ¡Œå·åˆ—è¡¨åˆ° LocalStorage å’Œ Firebase (åŒæ­¥) */
        function saveActiveTablesLocally() {
             localStorage.setItem('bbq_active_tables', JSON.stringify(activeTables));
             saveAllDataToFirebase('activeTables', activeTables);
        }

        /** * ä» syncedData ä¸­åŠ è½½è®¢å•å†å² */
        function loadOrderHistory() {
            return syncedData.history;
        }

        /** * ä¿å­˜è®¢å•å†å²åˆ° syncedData å¹¶åŒæ­¥åˆ°äº‘ç«¯ */
        function saveOrderHistory(orderHistory) {
            syncedData.history = orderHistory;
            saveAllDataToFirebase('history', syncedData.history);
        }
        
        /** * ä» syncedData ä¸­åŠ è½½æ”¶å…¥è®°å½• */
        function loadIncome() {
             return syncedData.income;
        }
        
        /** * ä¿å­˜æ”¶å…¥è®°å½•åˆ° syncedData å¹¶åŒæ­¥åˆ°äº‘ç«¯ */
        function saveIncome(income) {
             syncedData.income = income;
             saveAllDataToFirebase('income', syncedData.income);
        }
        
        /** * ä» syncedData ä¸­åŠ è½½æ”¯å‡ºè®°å½• */
        function loadExpense() {
            return syncedData.expense;
        }
        
        /** * ä¿å­˜æ”¯å‡ºè®°å½•åˆ° syncedData å¹¶åŒæ­¥åˆ°äº‘ç«¯ */
        function saveExpense(expense) {
             syncedData.expense = expense;
             saveAllDataToFirebase('expense', syncedData.expense);
        }

        // --- æ ¸å¿ƒç‚¹å•é€»è¾‘å‡½æ•° (ä»…è°ƒæ•´å‡½æ•°è°ƒç”¨ï¼Œç¡®ä¿ä¸€è‡´æ€§) ---

        /** * åˆ‡æ¢å½“å‰æ“ä½œçš„æ¡Œå· */ 
        async function switchTable(tableNumber) { 
            if (isEditMode || isSummaryMode) return; 

            playSound(); 
            vibrateDevice(); 

            // 1. åˆ‡æ¢èœå•å®¹å™¨çš„æ˜¾ç¤ºçŠ¶æ€
            const currentMenuContainer = document.querySelector(`.table-menu-container.active`);
            const nextMenuContainer = document.getElementById(`table-${tableNumber}-menu`);
            if (currentMenuContainer) {
                currentMenuContainer.classList.remove('active');
            }

            // 2. æ›´æ–°å½“å‰æ¡Œå·å¹¶æ¸²æŸ“
            currentTable = tableNumber;
            localStorage.setItem('bbq_last_table', String(currentTable)); 
            
            // åŠ¨æ€æ¸²æŸ“ä¼˜åŒ–ï¼šå¦‚æœç›®æ ‡èœå•ä¸å­˜åœ¨ï¼Œåˆ™é‡æ–°æ¸²æŸ“æ‰€æœ‰èœå•
            if (!nextMenuContainer || nextMenuContainer.innerHTML === '') {
                await renderAllMenus(); 
                const newlyRenderedMenu = document.getElementById(`table-${tableNumber}-menu`);
                if(newlyRenderedMenu) {
                    newlyRenderedMenu.classList.add('active');
                }
            } else {
                nextMenuContainer.classList.add('active');
            }
            
            // 3. æ›´æ–° UI
            const tableDisplay = (typeof currentTable === 'number' || (!isNaN(parseInt(currentTable)) && String(parseInt(currentTable)) === String(currentTable))) ? `${currentTable}å·æ¡Œ` : String(currentTable);
            tableSelectorDropbtn.textContent = tableDisplay;
            settleButton.textContent = `ç»“ç®—å¹¶æ¸…ç©º${tableDisplay}`;

            // åŠ è½½å¤‡æ³¨ä¿¡æ¯åˆ°è¾“å…¥æ¡† 
            orderNoteInput.value = loadTableNote(currentTable); 
            
            setTimeout(() => {
                updateBill();
            }, 50);
        } 

        /** * æŸ¥æ‰¾æœ€å°çš„ã€æœªè¢«å ç”¨çš„æ¡Œå· */ 
        function findNextAvailableTable() { 
            // ç¡®ä¿ activeTables å§‹ç»ˆæ˜¯æœ€æ–°ç‰ˆæœ¬
            activeTables = loadActiveTablesLocally(); 
            const sortedNumbers = [...activeTables].filter(t => typeof t === 'number' || (!isNaN(parseInt(t)) && String(parseInt(t)) === String(t))).map(t => parseInt(t)).sort((a, b) => a - b); 
            let nextTable = 1; 
            for (const tableNum of sortedNumbers) { 
                if (tableNum === nextTable) { 
                    nextTable++; 
                } else if (tableNum > nextTable) { 
                    return nextTable; 
                } 
            } 
            return nextTable; 
        } 

        /** * æ·»åŠ ä¸€ä¸ªæ–°çš„åŠ¨æ€æ¡Œå·ï¼Œæ”¯æŒè‡ªå®šä¹‰ */ 
        async function addNewTable() { 
            const defaultTableNumber = findNextAvailableTable(); 
            const customInput = prompt(`è¾“å…¥æ–°æ¡Œå· (æ•°å­—æˆ–å­—æ¯/ä¸­æ–‡)ï¼Œç•™ç©ºåˆ™ä½¿ç”¨é»˜è®¤æ¡Œå·: ${defaultTableNumber} å·æ¡Œ`); 
            let newTableIdentifier; 
            if (customInput !== null && customInput.trim() !== "") { 
                const trimmedInput = customInput.trim(); 
                const numberCheck = parseInt(trimmedInput); 
                if (!isNaN(numberCheck) && numberCheck > 0 && String(numberCheck) === trimmedInput) { 
                    newTableIdentifier = numberCheck; 
                } else { 
                    newTableIdentifier = trimmedInput; 
                } 
            } else { 
                newTableIdentifier = defaultTableNumber; 
            } 
            
            if (activeTables.map(String).includes(String(newTableIdentifier))) { 
                alert(`æ¡Œå· "${newTableIdentifier}" å·²å­˜åœ¨ï¼Œè¯·é‡æ–°è¾“å…¥ã€‚`); 
                return; 
            } 
            
            activeTables.push(newTableIdentifier); 
            activeTables.sort((a, b) => { 
                const aIsNum = typeof a === 'number' || (typeof a === 'string' && !isNaN(parseInt(a))); 
                const bIsNum = typeof b === 'number' || (typeof b === 'string' && !isNaN(parseInt(b))); 
                if (aIsNum && bIsNum) { 
                    return (parseInt(a) || Infinity) - (parseInt(b) || Infinity); 
                } else if (aIsNum) { 
                    return -1; 
                } else if (bIsNum) { 
                    return 1; 
                } else { 
                    return String(a).localeCompare(String(b)); 
                } 
            }); 
            
            // ã€ä¿®æ­£ã€‘æ›´æ–°æœ¬åœ°å’Œäº‘ç«¯çŠ¶æ€
            saveActiveTablesLocally(); 
            await switchTable(newTableIdentifier); 
            
            generateTableSelectors(); 
            
            alert(`å·²æ·»åŠ  "${newTableIdentifier}" å·æ¡Œ`); 
        } 

        /** * å°†è´¦å•å†…å®¹è½¬æ¢ä¸ºå›¾ç‰‡å¹¶ä¸‹è½½ */ 
        function printBillToImage() { 
            // ... (printBillToImage å‡½æ•°ä»£ç æœªæ”¹åŠ¨)
            const tableDisplay = (typeof currentTable === 'number' || (!isNaN(parseInt(currentTable)) && String(parseInt(currentTable)) === String(currentTable))) ? `${currentTable}å·æ¡Œ` : String(currentTable); 
            const currentOrder = loadCurrentOrder(currentTable); 
            const total = calculateTotal(currentOrder); 
            const currentNote = loadTableNote(currentTable); 
            const now = new Date(); 
            const timeString = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`; 

            let printContent = `<h2>çƒ§çƒ¤æ”¶æ®</h2>`; 
            printContent += `<p class="print-info">æ¡Œå·: ${tableDisplay}</p>`; 
            printContent += `<p class="print-info">æ—¶é—´: ${getTodayDateString()} ${timeString}</p>`; 
            printContent += `<hr>`; 
            printContent += `<div class="print-item"><strong>é¡¹ç›®</strong><strong>æ•°é‡ x å•ä»·</strong></div>`; 
            printContent += `<hr>`; 
            
            for (const itemName in currentOrder) { 
                const quantity = currentOrder[itemName]; 
                const item = menuItems.find(i => i.name === itemName); 
                if (quantity > 0 && item) { 
                    printContent += `<div class="print-item"><span>${itemName}</span><span>${quantity} x ${formatPrice(item.price)}</span></div>`; 
                } 
            } 
            
            printContent += `<hr>`; 
            if (currentNote) { 
                printContent += `<p>å¤‡æ³¨: ${currentNote}</p>`; 
                printContent += `<hr>`; 
            } 
            printContent += `<div class="print-total">æ€»è®¡é‡‘é¢: ${formatPrice(total)} Ks</div>`; 
            printContent += `<p style="text-align: center; margin-top: 20px;">è°¢è°¢æƒ é¡¾ï¼</p>`; 

            printArea.innerHTML = printContent; 
            printArea.style.display = 'block'; 
            printArea.style.opacity = '1'; 
            printArea.style.position = 'relative'; 
            printArea.style.top = '0'; 
            printArea.style.left = '0'; 

            html2canvas(printArea, { 
                scale: 3, 
                useCORS: true, 
                backgroundColor: '#ffffff', 
            }).then(canvas => { 
                printArea.style.display = 'none'; 
                printArea.style.opacity = '0'; 
                printArea.style.position = 'absolute'; 
                printArea.style.top = '-9999px'; 
                printArea.style.left = '-9999px'; 

                const link = document.createElement('a'); 
                link.download = `BBQ_Bill_${tableDisplay}_${Date.now()}.png`; 
                link.href = canvas.toDataURL('image/png'); 
                link.click(); 

                alert(`æ”¶æ®å›¾ç‰‡å·²ç”Ÿæˆå¹¶ä¸‹è½½åˆ°æ‚¨çš„è®¾å¤‡ã€‚\næ¡Œå·: ${tableDisplay}\næ€»è®¡: ${formatPrice(total)} Ks`); 
            }).catch(error => { 
                console.error("ç”Ÿæˆå›¾ç‰‡å¤±è´¥:", error); 
                alert("ç”Ÿæˆå›¾ç‰‡å¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æƒé™ã€‚"); 

                printArea.style.display = 'none'; 
                printArea.style.opacity = '0'; 
                printArea.style.position = 'absolute'; 
                printArea.style.top = '-9999px'; 
                printArea.style.left = '-9999px'; 
            }); 
        } 

        /** * æ¸²æŸ“å•ä¸ªèœå•é¡¹çš„ HTML */ 
        function renderMenuItem(item) { 
            const currentOrder = loadCurrentOrder(currentTable); 
            const quantity = currentOrder[item.name] || 0; 
            // ... (renderMenuItem å‡½æ•°ä»£ç æœªæ”¹åŠ¨)
            return `<div class="item" data-id="${item.id}" data-name="${item.name}" onclick="updateQuantity('${item.name}', 1)">
                        <img src="${item.imageUrl || defaultPlaceholder}" alt="${item.name}" class="item-image" onerror="this.onerror=null;this.src='${defaultPlaceholder}';">
                        <div class="item-info">
                            <h3>${item.name}</h3>
                            <p>${formatPrice(item.price)} Ks</p>
                        </div>
                        <div class="item-controls" onclick="event.stopPropagation()">
                            <button onclick="updateQuantity('${item.name}', -1)">-</button>
                            <input type="number" id="qty-${item.id}" value="${quantity}" min="0" onchange="setQuantity('${item.name}', this.value)" readonly>
                            <button onclick="updateQuantity('${item.name}', 1)">+</button>
                        </div>
                    </div>`;
        } 

        /** * æ¸²æŸ“å•ä¸ªèœå• (æ¡Œå·) çš„å†…å®¹ */
        function renderMenuForTable(tableNumber) {
            const tableContainerId = `table-${tableNumber}-menu`;
            let tableContainer = document.getElementById(tableContainerId);

            if (!tableContainer) {
                tableContainer = document.createElement('div');
                tableContainer.id = tableContainerId;
                tableContainer.className = 'table-menu-container'; 
                menuArea.appendChild(tableContainer);
            }
            
            if (String(tableNumber) === String(currentTable)) {
                 tableContainer.classList.add('active');
            } else {
                 tableContainer.classList.remove('active');
            }

            const categories = menuItems.reduce((acc, item) => {
                const category = item.category || 'å…¶ä»–';
                if (!acc[category]) {
                    acc[category] = [];
                }
                acc[category].push(item);
                return acc;
            }, {});

            let menuHtml = '';
            for (const category in categories) {
                menuHtml += `<div class="category-section">`;
                menuHtml += `<div class="category-header">${category}</div>`;
                menuHtml += `<div class="category-content">`;
                categories[category].forEach(item => {
                    menuHtml += renderMenuItem(item);
                });
                menuHtml += `</div></div>`;
            }

            tableContainer.innerHTML = menuHtml;
        }

        /** * æ¸²æŸ“æ‰€æœ‰æ´»è·ƒæ¡Œå·çš„èœå• DOM */
        async function renderAllMenus() {
            activeTables = loadActiveTablesLocally(); 
            
            menuArea.innerHTML = '';
            
            activeTables.forEach(tableNumber => {
                renderMenuForTable(tableNumber);
            });
        }

        /** * æ›´æ–°å½“å‰æ¡Œçš„è´¦å•æ˜ç»† */
        function updateBill() {
            const currentOrder = loadCurrentOrder(currentTable); 
            let total = 0;
            let billHtml = '';
            let hasItems = false;
            
            // å¤‡æ³¨åŒæ­¥ï¼šç¡®ä¿è¾“å…¥æ¡†å†…å®¹ç«‹å³åŒæ­¥åˆ°å†…å­˜å’Œäº‘ç«¯
            const currentNote = orderNoteInput.value;
            saveTableNote(currentTable, currentNote);
            currentNoteDisplay.innerHTML = currentNote ? `å¤‡æ³¨: <strong>${currentNote}</strong>` : '';

            for (const itemName in currentOrder) {
                const quantity = currentOrder[itemName];
                const item = menuItems.find(i => i.name === itemName);

                if (quantity > 0 && item) {
                    hasItems = true;
                    const subtotal = item.price * quantity;
                    total += subtotal;

                    billHtml += `<div class="item-row" data-name="${itemName}">
                        <span>${itemName} (x${quantity})</span>
                        <span class="item-total">${formatPrice(subtotal)} Ks</span>
                    </div>`;

                    // ç¡®ä¿èœå•é¡¹ä¸Šçš„æ•°é‡è¾“å…¥æ¡†ä¹ŸåŒæ­¥æ›´æ–° 
                    const itemElement = document.querySelector(`.table-menu-container.active .item[data-name="${itemName}"]`);
                    if (itemElement) {
                        const qtyInput = itemElement.querySelector('input[type="number"]');
                        if (qtyInput) {
                            qtyInput.value = quantity;
                        }
                    }
                }
            }
            
            billDetails.innerHTML = hasItems ? billHtml : '<p style="text-align: center; color: #999;">å½“å‰æ¡Œå­æ²¡æœ‰ç‚¹å•ã€‚</p>';
            totalPriceSpan.textContent = formatPrice(total);
            
            // ä¿å­˜å½“å‰è®¢å•çŠ¶æ€
            saveCurrentOrder(currentTable, currentOrder);
        }

        /** * å¢åŠ æˆ–å‡å°‘èœå“æ•°é‡ */
        function updateQuantity(itemName, change) {
            initAudioContext(); 
            
            const currentOrder = loadCurrentOrder(currentTable); 
            const currentQty = currentOrder[itemName] || 0;
            let newQty = currentQty + change;
            
            if (newQty < 0) {
                newQty = 0;
            }

            if (newQty > 0) {
                currentOrder[itemName] = newQty;
            } else {
                delete currentOrder[itemName];
            }

            playSound();
            vibrateDevice();

            saveCurrentOrder(currentTable, currentOrder); 
            
            // ç«‹å³æ›´æ–°å½“å‰èœå•é¡¹çš„æ˜¾ç¤ºæ•°é‡
            const item = menuItems.find(i => i.name === itemName);
            if (item) {
                const qtyInput = document.getElementById(`qty-${item.id}`);
                if (qtyInput) {
                    qtyInput.value = newQty;
                }
            }
            
            updateBill(); 
        }
        
        /** * ç›´æ¥è®¾ç½®èœå“æ•°é‡ */
        function setQuantity(itemName, value) {
            const newQty = parseInt(value) || 0;
            const currentOrder = loadCurrentOrder(currentTable); 

            if (newQty > 0) {
                currentOrder[itemName] = newQty;
            } else {
                delete currentOrder[itemName];
            }
            
            saveCurrentOrder(currentTable, currentOrder); 
            updateBill();
        }

        /** * ç”Ÿæˆæ¡Œå·é€‰æ‹©å™¨ä¸‹æ‹‰èœå• */
        function generateTableSelectors() {
            activeTables = loadActiveTablesLocally(); 
            tableDropdownContent.innerHTML = '';

            activeTables.forEach(tableNumber => {
                const tableDisplay = (typeof tableNumber === 'number' || (!isNaN(parseInt(tableNumber)) && String(parseInt(tableNumber)) === String(tableNumber))) ? `${tableNumber}å·æ¡Œ` : String(tableNumber);
                
                const tableItem = document.createElement('a');
                tableItem.href = `#`;
                tableItem.textContent = tableDisplay;
                tableItem.onclick = (e) => {
                    e.preventDefault();
                    switchTable(tableNumber);
                    document.getElementById('table-selector-dropbtn').parentNode.classList.remove('open');
                };

                // æ·»åŠ åˆ é™¤æŒ‰é’® 
                if (String(tableNumber) !== String(currentTable) && activeTables.length > 1) {
                     const deleteBtn = document.createElement('span');
                     deleteBtn.textContent = ' âŒ';
                     deleteBtn.style.cursor = 'pointer';
                     deleteBtn.style.marginLeft = '10px';
                     deleteBtn.onclick = (e) => {
                         e.preventDefault();
                         e.stopPropagation(); 
                         deleteTable(tableNumber);
                     };
                     tableItem.appendChild(deleteBtn);
                }


                tableDropdownContent.appendChild(tableItem);
            });

            const hr = document.createElement('hr');
            hr.style.margin = '5px 0';
            hr.style.border = '0';
            hr.style.borderTop = '1px solid #ddd';
            tableDropdownContent.appendChild(hr);


            const addTableLink = document.createElement('a');
            addTableLink.href = `#`;
            addTableLink.textContent = '+ æ·»åŠ æ–°æ¡Œå·';
            addTableLink.classList.add('add-table-link');
            addTableLink.onclick = (e) => {
                e.preventDefault();
                addNewTable();
                document.getElementById('table-selector-dropbtn').parentNode.classList.remove('open');
            };
            tableDropdownContent.appendChild(addTableLink);
            
            const tableDisplay = (typeof currentTable === 'number' || (!isNaN(parseInt(currentTable)) && String(parseInt(currentTable)) === String(currentTable))) ? `${currentTable}å·æ¡Œ` : String(currentTable);
            tableSelectorDropbtn.textContent = tableDisplay;
        }

        /** * åˆ é™¤ä¸€ä¸ªæ¡Œå· */
        async function deleteTable(tableNumberToDelete) {
             if (activeTables.length <= 1) {
                 alert("ä¸èƒ½åˆ é™¤æœ€åä¸€ä¸ªæ¡Œå·ï¼");
                 return;
             }
             
             if (confirm(`ç¡®å®šè¦åˆ é™¤ ${tableNumberToDelete} å·æ¡Œå¹¶æ¸…ç©ºå…¶è®¢å•å—ï¼Ÿ`)) {
                 activeTables = activeTables.filter(t => String(t) !== String(tableNumberToDelete));
                 
                 const tableKey = String(tableNumberToDelete);
                 if (syncedData.tables[tableKey]) {
                     delete syncedData.tables[tableKey];
                     saveAllDataToFirebase('tables', syncedData.tables); // åŒæ­¥åˆ°äº‘ç«¯
                 }
                 
                 if (String(currentTable) === String(tableNumberToDelete)) {
                     currentTable = activeTables[0];
                     localStorage.setItem('bbq_last_table', String(currentTable)); 
                 }
                 
                 saveActiveTablesLocally(); 
                 
                 await renderAllMenus();
                 generateTableSelectors();
                 updateBill();
                 
                 alert(`${tableNumberToDelete} å·æ¡Œå·²åˆ é™¤ã€‚`);
             }
        }


        /** * ç»“ç®—å¹¶æ¸…ç©ºå½“å‰æ¡Œçš„è®¢å• */
        async function settleAndClear() {
            const currentOrder = loadCurrentOrder(currentTable); 
            if (Object.keys(currentOrder).length === 0) {
                alert("å½“å‰æ¡Œå­æ²¡æœ‰ç‚¹å•ï¼");
                return;
            }

            const tableDisplay = (typeof currentTable === 'number' || (!isNaN(parseInt(currentTable)) && String(parseInt(currentTable)) === String(currentTable))) ? `${currentTable}å·æ¡Œ` : String(currentTable);
            
            if (confirm(`ç¡®å®šè¦ç»“ç®—å¹¶æ¸…ç©º ${tableDisplay} çš„è´¦å•å—ï¼Ÿ`)) {
                
                printBillToImage();

                const orderTotal = calculateTotal(currentOrder);
                const currentNote = loadTableNote(currentTable); 
                
                const orderRecord = {
                    id: Date.now(),
                    date: getTodayDateString(),
                    table: currentTable,
                    items: currentOrder, 
                    total: orderTotal,
                    note: currentNote,
                    type: 'é”€å”®è®¢å•'
                };
                
                let orderHistory = loadOrderHistory();
                orderHistory.unshift(orderRecord);
                saveOrderHistory(orderHistory); 
                
                // æ¸…ç©ºå½“å‰è®¢å•æ•°æ®
                saveCurrentOrder(currentTable, {}); 
                saveTableNote(currentTable, '');
                orderNoteInput.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
                
                updateBill(); 

                alert(`ç»“ç®—æˆåŠŸï¼${tableDisplay} æ€»è®¡: ${formatPrice(orderTotal)} Ks`);
            }
        }

        /** * åˆ‡æ¢ç¼–è¾‘æ¨¡å¼ (èœå•) */
        function toggleEditMode() {
            isSummaryMode = false;
            if (!isEditMode) {
                isEditMode = true;
                mainContent.style.display = 'none';
                summaryContent.style.display = 'none';
                editContent.style.display = 'block';
                editLink.textContent = 'è¿”å›ç‚¹å•';
                summaryLink.textContent = 'æŸ¥çœ‹æ±‡æ€»';
                loadMenuItems().then(() => {
                    renderMenuEditor();
                });
            } else {
                isEditMode = false;
                editContent.style.display = 'none';
                mainContent.style.display = 'flex';
                editLink.textContent = 'ç¼–è¾‘èœå•';
                loadMenuItems().then(() => {
                    renderAllMenus();
                    updateBill();
                });
            }
        }

        /** * æ¸²æŸ“èœå•ç¼–è¾‘å™¨çš„è¡¨æ ¼å†…å®¹ */
        function renderMenuEditor() {
            const menuEditorBody = document.getElementById('menu-editor-body');
            menuEditorBody.innerHTML = '';

            menuItems.forEach(item => {
                const row = menuEditorBody.insertRow();
                row.dataset.id = item.id;
                
                const nameCell = row.insertCell();
                nameCell.innerHTML = `<input type="text" value="${item.name || ''}" data-field="name">`;
                
                const priceCell = row.insertCell();
                priceCell.innerHTML = `<input type="number" value="${item.price || 0}" data-field="price" min="0" step="100">`;
                
                const categoryCell = row.insertCell();
                categoryCell.innerHTML = `<input type="text" value="${item.category || ''}" data-field="category">`;
                
                const imageCell = row.insertCell();
                imageCell.innerHTML = `<input type="text" value="${item.imageUrl || ''}" data-field="imageUrl" placeholder="å›¾ç‰‡ URL (å¯é€‰)">`;
                
                const actionCell = row.insertCell();
                actionCell.innerHTML = `<button onclick="deleteItem(${item.id})">åˆ é™¤</button>`;
            });
        }

        /** * æ·»åŠ æ–°çš„èœå•é¡¹ï¼ˆåœ¨ç¼–è¾‘æ¨¡å¼ä¸‹ï¼‰ */
        function addNewItem() {
            const menuEditorBody = document.getElementById('menu-editor-body');
            const row = menuEditorBody.insertRow();
            const tempId = 'new-' + Date.now(); 
            row.dataset.id = tempId; 
            
            const nameCell = row.insertCell();
            nameCell.innerHTML = `<input type="text" value="" data-field="name" placeholder="æ–°èœå“åç§°">`;
            
            const priceCell = row.insertCell();
            priceCell.innerHTML = `<input type="number" value="0" data-field="price" min="0" step="100">`;
            
            const categoryCell = row.insertCell();
            categoryCell.innerHTML = `<input type="text" value="" data-field="category" placeholder="åˆ†ç±»">`;
            
            const imageCell = row.insertCell();
            imageCell.innerHTML = `<input type="text" value="" data-field="imageUrl" placeholder="å›¾ç‰‡ URL (å¯é€‰)">`;
            
            const actionCell = row.insertCell();
            actionCell.innerHTML = `<button onclick="deleteItem('${tempId}')">åˆ é™¤</button>`;
        }

        /** * ä¿å­˜æ‰€æœ‰èœå•é¡¹ (ç¼–è¾‘æ¨¡å¼) */
        async function saveAllMenuItems() {
             const menuEditorBody = document.getElementById('menu-editor-body');
             const rows = menuEditorBody.querySelectorAll('tr');
             let hasError = false;

             for (const row of rows) {
                 const inputs = row.querySelectorAll('input');
                 const item = {
                     id: isNaN(parseInt(row.dataset.id)) ? row.dataset.id : parseInt(row.dataset.id), 
                     name: row.querySelector('[data-field="name"]').value.trim(),
                     price: parseFloat(row.querySelector('[data-field="price"]').value) || 0,
                     category: row.querySelector('[data-field="category"]').value.trim(),
                     imageUrl: row.querySelector('[data-field="imageUrl"]').value.trim()
                 };

                 if (!item.name || item.price <= 0 || !item.category) {
                     alert(`èœå“åç§°ã€ä»·æ ¼å’Œåˆ†ç±»ä¸èƒ½ä¸ºç©ºæˆ–ä»·æ ¼å¿…é¡»å¤§äº0ï¼é—®é¢˜èœå“: ${item.name || 'æœªå‘½å'}`);
                     hasError = true;
                     break;
                 }
                 
                 if (typeof item.id === 'string' && item.id.startsWith('new-')) {
                     delete item.id;
                 }
                 
                 const newId = await saveMenuItemToDB(item);
                 row.dataset.id = newId; 
             }
             
             if (!hasError) {
                 alert("èœå•å·²ä¿å­˜å¹¶åŒæ­¥åˆ°äº‘ç«¯ï¼");
                 await loadMenuItems();
                 renderMenuEditor();
             }
        }

        /** * åˆ é™¤èœå•é¡¹ (ç¼–è¾‘æ¨¡å¼) */
        async function deleteItem(id) {
             if (confirm("ç¡®å®šè¦åˆ é™¤æ­¤èœå“å—ï¼Ÿ")) {
                 try {
                     const row = document.querySelector(`tr[data-id="${id}"]`);
                     if (row) row.remove();
                     
                     if (typeof id === 'string' && id.startsWith('new-')) {
                     } else {
                         const numericId = parseInt(id);
                         await deleteMenuItemFromDB(numericId);
                         alert("èœå“å·²åˆ é™¤å¹¶åŒæ­¥ã€‚");
                     }
                     
                 } catch (error) {
                     console.error("åˆ é™¤èœå•é¡¹å¤±è´¥:", error);
                     alert("åˆ é™¤èœå•é¡¹å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°ã€‚");
                 }
             }
        }

        /** * åˆ‡æ¢æ±‡æ€»æ¨¡å¼ */
        function toggleSummaryMode() {
            isEditMode = false;
            if (!isSummaryMode) {
                isSummaryMode = true;
                mainContent.style.display = 'none';
                editContent.style.display = 'none';
                summaryContent.style.display = 'block';
                summaryLink.textContent = 'è¿”å›ç‚¹å•';
                editLink.textContent = 'ç¼–è¾‘èœå•';
                updateSummaryUI();
            } else {
                isSummaryMode = false;
                summaryContent.style.display = 'none';
                mainContent.style.display = 'flex';
                summaryLink.textContent = 'æŸ¥çœ‹æ±‡æ€»';
                updateBill(); 
            }
        }
        
        /** * åˆ‡æ¢æ±‡æ€»è§†å›¾ (æŸç›Š/æ”¶å…¥/æ”¯å‡º) */
        function showSummaryView(view) {
            document.getElementById('profit-loss-view').style.display = 'none';
            document.getElementById('income-view').style.display = 'none';
            document.getElementById('expense-view').style.display = 'none';

            document.getElementById(`${view}-view`).style.display = 'block';

            document.querySelectorAll('#summary-nav button').forEach(btn => {
                btn.style.opacity = 0.7;
            });
            document.querySelector(`#summary-nav button[onclick*="${view}"]`).style.opacity = 1.0;
        }

        /** * æ¸²æŸ“æ±‡æ€» UI */
        function updateSummaryUI() {
            const history = loadOrderHistory(); 
            const income = loadIncome(); 
            const expense = loadExpense(); 

            // ... (updateSummaryUI å‡½æ•°ä»£ç æœªæ”¹åŠ¨)
            
            // 1. æŸç›Šæ±‡æ€»è§†å›¾
            const summaryContainer = document.getElementById('summary-container');
            summaryContainer.innerHTML = '';
            
            // æŒ‰æ—¥æœŸåˆ†ç»„è®¢å•
            const dailySales = history.reduce((acc, order) => {
                const date = order.date;
                if (!acc[date]) {
                    acc[date] = { total: 0, count: 0, orders: [] };
                }
                acc[date].total += order.total;
                acc[date].count++;
                acc[date].orders.push(order);
                return acc;
            }, {});
            
            // æŒ‰æ—¥æœŸåˆ†ç»„æ”¶å…¥/æ”¯å‡º
            const dailyOtherIncome = income.reduce((acc, item) => {
                 const date = item.date;
                 acc[date] = (acc[date] || 0) + item.amount;
                 return acc;
            }, {});
            const dailyExpense = expense.reduce((acc, item) => {
                 const date = item.date;
                 acc[date] = (acc[date] || 0) + item.amount;
                 return acc;
            }, {});

            // åˆå¹¶æ‰€æœ‰æ—¥æœŸå¹¶æ’åº
            const allDates = [...new Set([...Object.keys(dailySales), ...Object.keys(dailyOtherIncome), ...Object.keys(dailyExpense)])].sort().reverse();
            let grandTotalProfit = 0;

            allDates.forEach(date => {
                const sales = dailySales[date] ? dailySales[date].total : 0;
                const otherIncome = dailyOtherIncome[date] || 0;
                const dailyExpenses = dailyExpense[date] || 0;
                const dailyTotalIncome = sales + otherIncome;
                const dailyProfit = dailyTotalIncome - dailyExpenses;
                grandTotalProfit += dailyProfit;

                let dailyHtml = `<div class="daily-summary-section">`;
                dailyHtml += `<h3>${date} æŸç›Š</h3>`;
                
                dailyHtml += `<p>é”€å”®æ€»é¢: ${formatPrice(sales)} Ks (${dailySales[date] ? dailySales[date].count : 0} ç¬”)</p>`;
                dailyHtml += `<p>å…¶ä»–æ”¶å…¥: ${formatPrice(otherIncome)} Ks</p>`;
                dailyHtml += `<p style="color: #e74c3c;">æ€»æ”¯å‡º: ${formatPrice(dailyExpenses)} Ks</p>`;
                dailyHtml += `<p class="daily-total">å½“æ—¥æŸç›Š: ${formatPrice(dailyProfit)} Ks</p>`;
                
                if (dailySales[date] && dailySales[date].orders.length > 0) {
                     dailyHtml += `<details><summary style="cursor: pointer; color: #3498db;">è®¢å•è¯¦æƒ… (${dailySales[date].count} ç¬”)</summary><div class="order-details">`;
                     dailySales[date].orders.forEach(order => {
                          dailyHtml += `<p><strong>æ¡Œå· ${order.table}</strong>: ${formatPrice(order.total)} Ks ${order.note ? `(${order.note})` : ''}</p>`;
                          dailyHtml += `<ul class="order-items">`;
                          for (const name in order.items) {
                              dailyHtml += `<li>- ${name} x${order.items[name]}</li>`;
                          }
                          dailyHtml += `</ul>`;
                     });
                     dailyHtml += `</div></details>`;
                }

                dailyHtml += `</div>`;
                summaryContainer.innerHTML += dailyHtml;
            });

            document.getElementById('grand-total').textContent = `æ€»æŸç›Š: ${formatPrice(grandTotalProfit)} Ks`;
            
            
            // 2. æ”¶å…¥/æ”¯å‡ºåˆ—è¡¨è§†å›¾
            
            // å†å²æ”¶å…¥åˆ—è¡¨ (åŒ…å«é”€å”®è®¢å•)
            const allIncome = [...history, ...income].sort((a, b) => b.id - a.id);
            const incomeList = document.getElementById('income-list');
            incomeList.innerHTML = allIncome.map(item => `
                <div style="padding: 10px; border-bottom: 1px dashed #eee;">
                    <strong>${item.date}</strong> - ${item.type}: ${item.note || item.description || `æ¡Œå· ${item.table} é”€å”®`} 
                    <span style="float: right; color: #27ae60; font-weight: bold;">+${formatPrice(item.total || item.amount)} Ks</span>
                </div>
            `).join('');

            // å†å²æ”¯å‡ºåˆ—è¡¨
            const expenseList = document.getElementById('expense-list');
            expenseList.innerHTML = expense.sort((a, b) => b.id - a.id).map(item => `
                <div style="padding: 10px; border-bottom: 1px dashed #eee;">
                    <strong>${item.date}</strong> - ${item.description || 'æœªçŸ¥æ”¯å‡º'} 
                    <span style="float: right; color: #e74c3c; font-weight: bold;">-${formatPrice(item.amount)} Ks</span>
                </div>
            `).join('');

        }

        /** * æ·»åŠ å…¶ä»–æ”¶å…¥ */
        async function addIncome() {
             const date = document.getElementById('income-date').value;
             const description = document.getElementById('income-description').value.trim();
             const amount = parseFloat(document.getElementById('income-amount').value);

             if (!date || !description || isNaN(amount) || amount <= 0) {
                 alert("è¯·ç¡®ä¿è¾“å…¥æœ‰æ•ˆçš„æ—¥æœŸã€æè¿°å’Œé‡‘é¢ï¼");
                 return;
             }

             const newIncome = {
                 id: Date.now(),
                 date: date,
                 description: description,
                 amount: amount,
                 type: 'å…¶ä»–æ”¶å…¥'
             };
             
             syncedData.income.push(newIncome);
             saveIncome(syncedData.income); 
             
             document.getElementById('income-description').value = '';
             document.getElementById('income-amount').value = '';
             updateSummaryUI();
             alert(`æ”¶å…¥è®°å½•æˆåŠŸ: ${description}ï¼Œ${formatPrice(amount)} Ks`);
        }

        /** * æ·»åŠ æ”¯å‡º */
        async function addExpense() {
             const date = document.getElementById('expense-date').value;
             const description = document.getElementById('expense-description').value.trim();
             const amount = parseFloat(document.getElementById('expense-amount').value);

             if (!date || !description || isNaN(amount) || amount <= 0) {
                 alert("è¯·ç¡®ä¿è¾“å…¥æœ‰æ•ˆçš„æ—¥æœŸã€æè¿°å’Œé‡‘é¢ï¼");
                 return;
             }

             const newExpense = {
                 id: Date.now(),
                 date: date,
                 description: description,
                 amount: amount,
                 type: 'æ”¯å‡º'
             };
             
             syncedData.expense.push(newExpense);
             saveExpense(syncedData.expense);
             
             document.getElementById('expense-description').value = '';
             document.getElementById('expense-amount').value = '';
             updateSummaryUI();
             alert(`æ”¯å‡ºè®°å½•æˆåŠŸ: ${description}ï¼Œ${formatPrice(amount)} Ks`);
        }

        /** * å¯¼å‡ºå†å²è´¦å•åˆ° Excel */
        function exportToExcel() {
             // ... (exportToExcel å‡½æ•°ä»£ç æœªæ”¹åŠ¨)
             const history = loadOrderHistory(); 
             const income = loadIncome(); 
             const expense = loadExpense(); 

             if (history.length === 0 && income.length === 0 && expense.length === 0) {
                 alert("æ²¡æœ‰å†å²æ•°æ®å¯ä»¥å¯¼å‡ºï¼");
                 return;
             }

             const combinedData = [];

             history.forEach(order => {
                 combinedData.push({
                     æ—¥æœŸ: order.date,
                     ç±»å‹: order.type,
                     æ¡Œå·: order.table,
                     æè¿°: `é”€å”®è®¢å• (${Object.keys(order.items).map(k => `${k}x${order.items[k]}`).join(', ')})`,
                     æ”¶å…¥: order.total,
                     æ”¯å‡º: 0,
                     å¤‡æ³¨: order.note
                 });
             });

             income.forEach(item => {
                 combinedData.push({
                     æ—¥æœŸ: item.date,
                     ç±»å‹: item.type,
                     æ¡Œå·: '-',
                     æè¿°: item.description,
                     æ”¶å…¥: item.amount,
                     æ”¯å‡º: 0,
                     å¤‡æ³¨: ''
                 });
             });

             expense.forEach(item => {
                 combinedData.push({
                     æ—¥æœŸ: item.date,
                     ç±»å‹: item.type,
                     æ¡Œå·: '-',
                     æè¿°: item.description,
                     æ”¶å…¥: 0,
                     æ”¯å‡º: item.amount,
                     å¤‡æ³¨: ''
                 });
             });

             const worksheet = XLSX.utils.json_to_sheet(combinedData);
             const workbook = XLSX.utils.book_new();
             XLSX.utils.book_append_sheet(workbook, worksheet, "èµ„é‡‘æµæ°´");

             XLSX.writeFile(workbook, `BBQ_Finance_Export_${getTodayDateString()}.xlsx`);
             alert("æ•°æ®å·²å¯¼å‡ºä¸º Excel æ–‡ä»¶ï¼");
        }


        /** * æ¸…ç©ºæ‰€æœ‰å†å²è´¦å• */
        async function clearAllHistory() {
            if (confirm("è­¦å‘Šï¼šæ­¤æ“ä½œå°†æ°¸ä¹…æ¸…é™¤æ‰€æœ‰å†å²è®¢å•ã€æ”¶å…¥å’Œæ”¯å‡ºè®°å½•ï¼æ˜¯å¦ç»§ç»­ï¼Ÿ")) {
                // 1. æ¸…ç©ºå†…å­˜æ•°æ®
                syncedData.history = [];
                syncedData.income = [];
                syncedData.expense = [];

                // 2. æ¸…ç©º Firebase æ•°æ®
                saveAllDataToFirebase('history', []);
                saveAllDataToFirebase('income', []);
                saveAllDataToFirebase('expense', []);

                // 3. æ¸…ç©ºæœ¬åœ° IndexedDB å†å² (ä»…ä½œä¸ºæ¸…ç†ï¼Œå®é™…ä»¥å†…å­˜å’Œäº‘ç«¯ä¸ºå‡†)
                if (!db) await openDB();
                db.transaction(['orders_history', 'income_store', 'expense_store'], 'readwrite').objectStore('orders_history').clear();
                db.transaction(['orders_history', 'income_store', 'expense_store'], 'readwrite').objectStore('income_store').clear();
                db.transaction(['orders_history', 'income_store', 'expense_store'], 'readwrite').objectStore('expense_store').clear();
                
                alert("æ‰€æœ‰å†å²è®°å½•å·²æ¸…é™¤ã€‚");
                updateSummaryUI(); 
            }
        }
        
        let isInitialized = false;

        // ----------------------- åˆå§‹åŒ–å‡½æ•° (æœ€ç»ˆä¿®æ­£) -----------------------

        /** * åˆå§‹åŒ– UI å’Œæ•°æ®åŠ è½½ */
        async function initializeUI() {
            // 0. åˆå§‹åŒ– Firebase (å¼‚æ­¥è®¾ç½®ç›‘å¬å™¨)
            initializeFirebase(); 

            // 1. åŠ è½½èœå•é¡¹ (ä» IndexedDB æˆ–é»˜è®¤å€¼åŠ è½½)
            await loadMenuItems(); 
            
            // 2. åŠ è½½æ´»è·ƒæ¡Œå·åˆ—è¡¨ (ä» LocalStorage ä¼˜å…ˆ)
            activeTables = loadActiveTablesLocally();
            
            // 3. ç¡®å®šå½“å‰æ¡Œå·
            let lastTable = localStorage.getItem('bbq_last_table'); 
            
            if (lastTable !== null) {
                 const numberCheck = parseInt(lastTable);
                 if (!isNaN(numberCheck) && String(numberCheck) === lastTable) {
                    lastTable = numberCheck;
                 }
            }
             
            if (lastTable !== null && activeTables.map(String).includes(String(lastTable))) {
                currentTable = lastTable;
            } else {
                currentTable = activeTables[0] || 1; 
            }
            
            // 4. UI ç»‘å®šå’Œæ¸²æŸ“ - ç«‹å³æ¸²æŸ“ï¼Œç¡®ä¿åŠŸèƒ½å¯ç”¨
            orderNoteInput.addEventListener('input', updateBill); 
            orderNoteInput.value = loadTableNote(currentTable); 

            await renderAllMenus(); 
            generateTableSelectors(); 
            updateBill();
            
            const tableDisplay = (typeof currentTable === 'number' || (!isNaN(parseInt(currentTable)) && String(parseInt(currentTable)) === String(currentTable))) ? `${currentTable}å·æ¡Œ` : String(currentTable);
            settleButton.textContent = `ç»“ç®—å¹¶æ¸…ç©º${tableDisplay}`;
            
            isInitialized = true;
        }

        // ç»‘å®š AudioContext æ¢å¤é€»è¾‘åˆ°ç”¨æˆ·é¦–æ¬¡ç‚¹å‡»
        document.addEventListener('click', () => {
            if (audioContext && audioContext.state === 'suspended') {
                audioContext.resume().catch(e => console.error("AudioContext æ¢å¤å¤±è´¥:", e));
            }
        }, { once: true });


        // ç»‘å®š DOMContentLoaded äº‹ä»¶
        document.addEventListener('DOMContentLoaded', () => {
            initializeUI();
        });
    </script>
</body>
</html>
