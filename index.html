 <!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>烧烤账单计算器10.19.17.00 - 云同步增强版</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

    <style>
        /* ----------------------- CSS 样式区 - 界面布局和美化 ----------------------- */
        
        /* 引入现代字体 */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');

        /* 整体页面样式 */
        body {
            font-family: 'Poppins', 'Microsoft YaHei', 'SimHei', Arial, sans-serif;
            background: linear-gradient(135deg, #e36711, #ffbe91);
            padding: 20px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            color: #333;
            margin: 0;
        }

        /* 关键：控制不同桌子菜单的显示状态 */
        .table-menu-container {
            display: none;
        }
        .table-menu-container.active {
            display: block;
        }
        
        /* 隐藏数量输入框的上下箭头 */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        /* ----------------------- 打印样式 (用于图片转换时的样式基准) ----------------------- */
           
        #print-area {
            /* 允许 JS 临时设置为 'block' */
            display: none; 
            
            /* 模拟收据纸宽度，确保图片尺寸合理 */
            width: 300px; 
            margin: 0; 
            padding: 10px;
            background-color: #fff; /* 背景色必须是白色，否则图片会透明 */
            font-family: 'Microsoft YaHei', 'SimHei', monospace;
            font-size: 14px;
            line-height:1.5;
            color: #000;
            box-sizing: border-box;
            position: absolute; /* 防止在页面上占位 */
            top: -9999px; /* 移到屏幕外 */
            left: -9999px;
            z-index: 9999;
            opacity: 0; /* 默认隐藏，用于防止闪烁 */
        }
        #print-area h2 {
            text-align: center;
            font-size: 20px;
            border-bottom: 2px solid #000;
            padding-bottom: 8px;
            margin-bottom: 10px;
            color: #000;
        }
        #print-area p {
            margin: 5px 0;
            font-size: 12px;
        }
        #print-area .print-item {
            display: flex;
            justify-content: space-between;
            margin-bottom:4px;
            font-size: 14px;
        }
        #print-area .print-total {
            font-size: 16px;
            font-weight: bold;
            text-align: center;
            border-top: 2px solid #000;
            padding-top: 10px;
            margin-top: 10px;
        }
        #print-area .print-info {
            font-size: 12px;
            margin-bottom: 10px;
        }
        #print-area hr {
            border: none;
            border-top: 1px dashed #000;
            margin: 10px 0;
        }
        
        /* ----------------------- 顶部控制栏样式 ----------------------- */
        .top-bar {
            display: flex;
            justify-content: flex-end; /* 修改: 将所有元素靠右对齐 */
            align-items: center;
            margin-bottom: 20px;
            z-index: 100;
            flex-wrap: nowrap;
            gap: 10px; /* 新增: 添加元素之间的间距 */
        }
        /* 调整: 取消 .top-bar .dropdown 的左边距 */
        .top-bar .dropdown {
            margin-left: 0; 
        }

     /* 备注输入框容器样式 - **修改以匹配按钮尺寸** */
        .note-input-container {
            display: flex;
            align-items: center;
            margin-top: 5px; /* 【新增】略微向下移动备注框 */
            /* 统一大小的参考值：dropbtn 默认高度是 12px*2(padding) + font-size */
            width: 150px; /* 默认宽度 */
        }

        /* 备注输入框样式 - **修改以匹配按钮尺寸** */
        .note-input {
            padding: 12px 20px; /* 匹配 .dropbtn 的 padding */
            border: 1px solid #ff7e5f;
            border-radius: 8px;
            width: 100%;
            box-sizing: border-box;
            font-size: 14px; /* 略小于 dropbtn 的 16px */
            background-color: rgba(255, 255, 255, 0.8);
            border: none;
            height: 44px; /* 统一高度，根据 padding 和 font-size 估算 */
        }

        /* 下拉菜单基础样式 */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        /* 下拉菜单按钮 - **统一大小** */
        .dropbtn {
            background-color: #ff7e5f;
            color: white;
            padding: 12px 20px;
            font-size: 16px;
            border: none;
            cursor: pointer;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: background-color 0.2s, transform 0.2s;
            height: 44px; 
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* 设置按钮图标样式 - **统一大小** */
        #settings-dropbtn {
            font-size: 24px;
            width: 44px; 
            padding: 0; 
        }

        /* 按钮悬停效果 */
        .dropbtn:hover {
            background-color: #ff5e3a;
            transform: translateY(-2px);
        }

        /* 下拉菜单内容容器 */
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: rgba(255, 255, 255, 0.9);
            min-width: 100px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            right: 0;
            border-radius: 8px;
            overflow: hidden;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .dropdown-content a {
            color: #333;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            transition: background-color 0.2s;
            /* 【修改点 1】靠右对齐 */
            text-align: right; 
        }

        .dropdown-content a:hover {
            background-color: rgba(255, 126, 95, 0.2);
        }

        /* 【修改点 2】新增：自定义添加桌号链接样式 */
        .add-table-link {
            color: #27ae60 !important; /* 绿色 */
            font-weight: bold;
        }

        /* 鼠标悬停在下拉菜单按钮上时显示内容 */
        .dropdown:hover .dropdown-content {
            display: block;
        }
        
        /* ----------------------- 主体内容区样式 ----------------------- */
        .main-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* 卡片容器基础样式 */
        .container, .bill-details-wrapper, .summary-total, .menu-editor-container, #summary-content {
            background-color: rgba(255, 255, 255, 0.4);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            backdrop-filter: blur(10px);
            flex-shrink: 0;
            overflow-x: hidden; 
        }
        
        /* 账单明细容器 */
        .bill-details-wrapper {
            overflow-y: auto;
            flex-grow: 1;
            min-height: 100px;
        }

        /* 标题样式 */
        h2 {
            border-bottom: 2px solid #ffc3a0;
            padding-bottom: 15px;
            margin-top: 0;
            color: #f39c12;
            font-weight: 600;
        }
        
        /* ----------------------- 移动端整体优化 - 自适应布局 ----------------------- */
        @media (max-width: 767px) {
            
            /* (1) 基础布局和间距压缩 */
            body {
                padding: 8px; /* 缩小边距 */
            }

            /* 调整容器内边距 */
            .container, .bill-details-wrapper, .summary-total, .menu-editor-container, #summary-content {
                padding: 12px; /* 缩小内边距 */
            }

            /* (2) 顶部控制栏优化 */
            .top-bar {
                margin-bottom: 10px;
                flex-wrap: wrap; 
                gap: 5px; /* 减小顶部元素间距 */
            }
            .note-input-container {
                flex-grow: 1; 
                max-width: none; 
                width: auto;
                order: 1;
                margin-bottom: 5px; /* 底部留白 */
            }
            
            /* 确保备注输入框在小屏幕上保持与按钮组一致的高度 */
            .note-input {
                padding: 6px 8px; /* 进一步缩小 padding */
                font-size: 13px;
                height: 32px; /* 统一更小的高度 */
            }
            
            /* 小屏按钮统一尺寸 */
            .dropbtn {
                padding: 6px 8px;
                font-size: 13px;
                height: 32px; /* 统一更小的高度 */
                order: 2; 
            }
            #settings-dropbtn {
                font-size: 18px;
                width: 32px;
                height: 32px;
            }
            .table-selector-dropdown {
                 order: 3;
            }
            .settings-dropdown {
                 order: 4;
            }
            
            /* (3) 账单明细压缩 */
            #bill-details .item-row {
                margin-bottom: 5px; /* 缩小行间距 */
                padding: 5px 0;
                font-size: 0.9em; /* 略微缩小字体 */
            }
            
            /* 账单总计压缩 */
            .total {
                font-size: 1.5em; 
            }
            
            /* 结算按钮压缩 */
            .action-buttons button {
                 padding: 8px 15px;
                 font-size: 0.9em;
            }
            
            /* (4) 菜单卡片优化 */
            .item {
                padding: 8px; /* 减少卡片内边距 */
            }
            
            .item-image {
                width: 60px; /* 进一步缩小图片 */
                height: 60px;
                margin-bottom: 5px;
            }
            .item-info h3 {
                font-size: 0.85em; /* 缩小标题 */
            }
            .item-controls button {
                width: 18px;
                height: 18px;
                font-size: 0.8em;
            }
            .item-controls input {
                width: 20px;
                font-size: 0.8em;
            }
            
            /* **核心修改：移除强制缩放**
               现在，菜单项 (`.item` 的 `calc(50% - 7.5px)`) 将自行适应屏幕宽度。
            */
            #menu-area, 
            .menu-editor-container, 
            #summary-content { 
                /* 移除 transform: scale(0.8); 和相关的 width/margin 覆盖，
                   让元素自然适应手机屏幕的宽度。
                */
            }
        }
        /* ----------------------- 菜品分类样式 ----------------------- */
        .category-section {
            margin-top: 25px;
            border: 1px solid #ffc3a0;
            border-radius: 10px;
            overflow: hidden;
            background-color: rgba(255, 255, 255, 0.7);
        }

        .category-header {
            background-color: #ff7e5f;
            color: white;
            padding: 15px 20px;
            font-size: 1.3em;
            font-weight: 600;
            cursor: default;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .category-content {
            padding: 10px;
            display: flex; 
            flex-wrap: wrap; 
            gap: 15px; 
        }

        /* Hide the first top margin to prevent double spacing */
        .category-section:first-child {
            margin-top: 0;
        }

        /* ----------------------- 菜品项样式 (正方形卡片) ----------------------- */
        
        .item {
            /* 默认两列，减去 gap */
            flex: 1 1 calc(50% - 7.5px); 
            max-width: calc(50% - 7.5px);

            /* 内部布局改为垂直，以便图片/信息/数量堆叠，形成方块感 */
            flex-direction: column; 
            align-items: center; /* 居中对齐 */
            text-align: center;
            
            padding: 10px; 
            background-color: rgba(255, 255, 255, 0.6);
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            backdrop-filter: blur(10px);
            cursor: pointer;
            box-sizing: border-box; /* 确保 padding 包含在宽度内 */
        }

        @media (min-width: 768px) {
            .item {
                flex: 1 1 calc(33.333% - 10px); /* 桌面端三列 */
                max-width: calc(33.333% - 10px);
            }
        }
        @media (min-width: 1024px) {
            .item {
                flex: 1 1 calc(25% - 11.25px); /* 宽屏四列 */
                max-width: calc(25% - 11.25px);
            }
        }

        .item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .item-image {
            width: 90px; /* 增加尺寸，增强方块感 */
            height: 90px;
            object-fit: cover;
            border-radius: 12px;
            margin-right: 0; 
            margin-bottom: 10px;
            border: 2px solid #ff7e5f;
            pointer-events: none;
        }

        .item-info {
            flex-grow: 0;
            margin-bottom: 10px;
            pointer-events: none;
            min-width: 0;
        }
        
        .item-info h3 {
            font-size: 1em;
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .item-info p {
            font-size: 0.9em;
            margin: 0;
        }

        /* 数量控制区：改为水平排列，更紧凑 */
        .item-controls {
            display: flex;
            flex-direction: row; /* 水平排列 */
            align-items: center;
            justify-content: center; /* 确保加减按钮组居中显示 */
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            padding: 3px;
            backdrop-filter: blur(10px);
            pointer-events: auto;
        }

        .item-controls input {
            width: 30px; 
            text-align: center;
            margin: 0 5px; 
            border: none;
            background-color: transparent;
            font-size: 1em;
            font-weight: 600;
        }
        
        .item-controls button {
            background-color: #ff7e5f;
            color: white;
            border: none;
            padding: 0;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1em;
            width: 25px; 
            height: 25px;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.2s, transform 0.2s;
        }

        .item-controls button:hover {
            background-color: #ff5e3a;
            transform: scale(1.1);
        }

        /* ----------------------- 账单明细样式 ----------------------- */
        /* 账单明细中的行样式 (性能优化：将item-row用于JS查找) */
        #bill-details .item-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px dashed #ffc3a0;
        }
        
        #bill-details .item-total {
            min-width: 100px;
            text-align: right;
            font-weight: 600;
        }
        
        /* 总计金额样式 */
        .total {
            font-size: 1.8em;
            font-weight: 700;
            text-align: right;
            color: #f39c12;
            padding-top: 15px;
        }

        /* 备注显示区样式 (新增) */
        #current-note-display {
            text-align: right; 
            margin-bottom: 10px; 
            font-size: 1.1em; 
            color: #555;
            min-height: 25px; /* 确保占位 */
        }
        
        .action-buttons {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        
        /* 结算按钮样式 */
        .action-buttons button {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 1em;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .action-buttons button:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
        }

        /* ----------------------- 菜单编辑模式样式 ----------------------- */
        .menu-editor-container {
            background-color: rgba(255, 255, 255, 0.4);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            backdrop-filter: blur(10px);
        }
        
        .menu-editor-container table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
            margin-bottom: 20px;
        }
        
        .menu-editor-container th,
        .menu-editor-container td {
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .menu-editor-container th {
            background-color: rgba(255, 195, 160, 0.3);
        }
        
        .menu-editor-container input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
        }
        
        .menu-editor-container button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
        }
        
        .menu-editor-container button:hover {
            background-color: #2980b9;
        }
        
        .add-new {
            background-color: #27ae60 !important;
            padding: 10px 20px !important;
        }
        
        .add-new:hover {
            background-color: #219653 !important;
        }

        /* ----------------------- 汇总模式样式 ----------------------- */
        #summary-content {
            background-color: rgba(255, 255, 255, 0.4);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            backdrop-filter: blur(10px);
        }
        
        .daily-summary-section {
            margin-bottom: 20px;
            padding: 15px;
            background-color: rgba(255, 255, 255, 0.6);
            border-radius: 8px;
        }
        
        .daily-summary-section h3 {
            color: #f39c12;
            margin-top: 0;
        }
        
        .daily-summary-section .daily-total {
            font-weight: bold;
            color: #e74c3c;
        }
        
        #grand-total {
            font-size: 1.5em;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            color: #f39c12;
        }
        
        .summary-action-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        .summary-action-buttons button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .summary-action-buttons button.export {
            background-color: #27ae60;
        }
        
        .summary-action-buttons button:hover {
            opacity: 0.9;
        }

        /* 新增：订单详情样式 */
        .order-details {
            margin-top: 10px;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 4px;
        }

        .order-details p {
            margin: 5px 0;
        }

        .order-items {
            list-style-type: none;
            padding: 0;
        }

        .order-items li {
            margin-bottom: 5px;
        }
        
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="note-input-container">
            <input type="text" id="order-note-input" placeholder="输入备注..." class="note-input">
        </div>

        <div class="dropdown table-selector-dropdown">
            <button id="table-selector-dropbtn" class="dropbtn table-selector-dropbtn">桌号</button>
            <div id="table-dropdown-content" class="dropdown-content">
                </div>
        </div>

        <div class="dropdown settings-dropdown">
            <button id="settings-dropbtn" class="dropbtn">&#9881;</button>
            <div id="action-dropdown" class="dropdown-content">
                <a href="#" id="summary-link" onclick="toggleSummaryMode()">查看汇总</a>
                <a href="#" id="edit-link" onclick="toggleEditMode()">编辑菜单</a>
            </div>
        </div>
    </div>

    <div id="main-content" class="main-container">
        <div class="container">
            <div id="menu-area"></div> 
        </div>
        
        <div class="bill-details-wrapper">
            <h2>账单明细 (当前桌号: <span id="current-table-display">1号桌</span>)</h2>
            <div id="bill-details"></div>
        </div>
        
        <div class="summary-total">
            <div id="current-note-display"></div>
            <hr>
            <div class="total">
                <p>总计：<span id="total-price">0.00</span> Ks</p>
            </div>
            <div class="action-buttons">
                <button id="settle-button" onclick="settleAndClear()">结算并清空</button>
            </div>
        </div>
    </div>
    
    <div id="edit-content" class="menu-editor-container" style="display: none;">
        <h2>菜单编辑</h2>
        <div style="color: #c0392b; margin-bottom: 15px; font-weight: bold;">
            ⚠️ 注意: 菜单更改会立即同步到所有设备。
        </div>
        <table>
            <thead>
                <tr>
                    <th>名称</th>
                    <th>价格</th>
                    <th>分类</th> <th>图片</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="menu-editor-body">
                </tbody>
        </table>
        <button class="add-new" onclick="addNewItem()">添加新菜品</button>
        <button onclick="saveAllMenuItems()" style="background-color: #3498db; margin-left: 10px;">保存所有</button>
        <button onclick="toggleEditMode()" style="background-color: #95a5a6; margin-left: 10px;">返回点单</button>
    </div>

    <div id="summary-content" style="display: none;">
        <h2>资金汇总管理</h2>
        
        <div id="summary-nav" style="display: flex; justify-content: center; gap: 15px; margin-bottom: 20px;">
            <button onclick="showSummaryView('profit-loss')" style="padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer; background-color: #f39c12; color: white; font-weight: bold; opacity: 1.0;">损益汇总</button>
            <button onclick="showSummaryView('income')" style="padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer; background-color: #27ae60; color: white; font-weight: bold; opacity: 0.7;">收入管理</button>
            <button onclick="showSummaryView('expense')" style="padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer; background-color: #e74c3c; color: white; font-weight: bold; opacity: 0.7;">支出管理</button>
        </div>

        <div id="profit-loss-view" style="display: block;">
            <h3 style="color: #f39c12; border-bottom: 1px solid #ffc3a0; padding-bottom: 10px;">每日/每月损益汇总</h3>
            <div id="summary-container"></div>
            <div id="grand-total">总损益: 0 Ks</div>
        </div>
        
        <div id="income-view" style="display: none;">
            <h3 style="color: #27ae60; border-bottom: 1px solid #ffc3a0; padding-bottom: 10px;">添加新的其他收入</h3>
            <div style="margin-bottom: 20px; display: flex; align-items: center; flex-wrap: wrap; gap: 10px;">
                <input type="date" id="income-date" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <input type="text" id="income-description" placeholder="收入描述" style="width: 150px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <input type="number" id="income-amount" placeholder="金额 (Ks)" style="width: 100px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <button onclick="addIncome()" style="background-color: #27ae60; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">记录收入</button>
            </div>
            <h3 style="color: #27ae60; border-bottom: 1px dashed #ffc3a0; padding-bottom: 10px;">历史收入记录 (含销售订单)</h3>
            <div id="income-list" style="margin-top: 20px;"></div>
        </div>
        
        <div id="expense-view" style="display: none;">
            <h3 style="color: #e74c3c; border-bottom: 1px solid #ffc3a0; padding-bottom: 10px;">添加新的支出</h3>
            <div style="margin-bottom: 20px; display: flex; align-items: center; flex-wrap: wrap; gap: 10px;">
                <input type="date" id="expense-date" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;"> 
                <input type="text" id="expense-description" placeholder="支出描述" style="width: 150px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <input type="number" id="expense-amount" placeholder="金额 (Ks)" style="width: 100px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <button onclick="addExpense()" style="background-color: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">记录支出</button>
            </div>
            <h3 style="color: #e74c3c; border-bottom: 1px dashed #ffc3a0; padding-bottom: 10px;">历史支出记录</h3>
            <div id="expense-list" style="margin-top: 20px;"></div>
        </div>


        <div class="summary-action-buttons">
            <button class="export" onclick="exportToExcel()">导出历史账单</button>
            <button onclick="clearAllHistory()">清空所有历史账单</button>
            <button onclick="toggleSummaryMode()">返回点单</button>
        </div>
    </div>

    <div id="print-area"></div>

    <script>
        // --- Firebase 配置与初始化 ---
        /* 【YOUR FIREBASE CONFIG HERE】 */
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY", 
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        let app;
        let db;
        let menuRef;
        let tablesRef;
        let historyRef;
        let incomeRef;
        let expenseRef;
        let currentTableRef;
        let currentOrderRef;
        let currentNoteRef;
        // 实时数据库的引用
        let tableListener; // 用于监听桌子列表变化的监听器
        let orderListener; // 用于监听当前桌子订单变化的监听器
        let noteListener; // 用于监听当前桌子备注变化的监听器

        // --- 全局变量和元素引用 ---
        let menuItems = []; // 实时同步的菜单数据
        let activeTables = []; // 实时同步的活跃桌号列表
        let currentTable = 1; // 当前操作的桌号
        let currentOrderData = {}; // 当前桌子的订单数据 (由 Firebase 实时更新)
        let currentNoteText = ""; // 当前桌子的备注 (由 Firebase 实时更新)
        
        let isEditMode = false;
        let isSummaryMode = false;

        // 获取 DOM 元素的引用
        const mainContent = document.getElementById('main-content');
        const editContent = document.getElementById('edit-content');
        const summaryContent = document.getElementById('summary-content');
        const menuArea = document.getElementById('menu-area');
        const billDetails = document.getElementById('bill-details');
        const totalPriceSpan = document.getElementById('total-price');
        const settleButton = document.getElementById('settle-button');
        const tableSelectorDropbtn = document.getElementById('table-selector-dropbtn');
        const tableDropdownContent = document.getElementById('table-dropdown-content');
        const editLink = document.getElementById('edit-link');
        const summaryLink = document.getElementById('summary-link');
        const printArea = document.getElementById('print-area'); 
        const currentTableDisplay = document.getElementById('current-table-display'); 
        
        // 备注输入框和显示区域的引用
        const orderNoteInput = document.getElementById('order-note-input');
        const currentNoteDisplay = document.getElementById('current-note-display'); 
        
        const defaultPlaceholder = "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNzAiIGhlaWdodD0iNzAiIHZpZXdCb3g9IjAgMCA3MCA3MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMuLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSI3MCIgaGVpZ2h0PSI3MCIgcng9IjgiIGZpbGw9IiNGRjNBNTAiLz4KPHBhdGggZD09Ik0zNSAzNUwzNSAyNUwzNSA0NU00NSAzNUwyNSAzNSIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiLz4KPC9zdmc+Cg==";

        // --- 音频上下文全局管理 ---
        let audioContext;

        /** * 确保 AudioContext 在用户交互后处于活动状态 */
        function initAudioContext() {
            if (!audioContext) {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.error("AudioContext 初始化失败:", e);
                }
            }
        }

        // --- Firebase 核心函数 ---

        /** * 播放音效（用于点单反馈） */
        function playSound() {
            // ... (保持原有的 playSound 函数不变) ...
             requestAnimationFrame(() => {
                if (!audioContext || audioContext.state === 'suspended') {
                    initAudioContext();
                    if (audioContext && audioContext.state === 'suspended') {
                        audioContext.resume().catch(e => console.error("AudioContext 恢复失败:", e));
                    }
                }
                if (!audioContext || audioContext.state !== 'running') {
                    return;
                }
                try {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    oscillator.type = 'sine';
                    oscillator.frequency.value = 800;
                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    oscillator.start();
                    gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.05);
                    oscillator.stop(audioContext.currentTime + 0.05);
                    oscillator.onended = () => {
                        oscillator.disconnect();
                        gainNode.disconnect();
                    };
                } catch (e) {
                    console.error("音频播放失败:", e);
                }
            });
        }
        
        /** * 触发设备震动（用于点单反馈） */
        function vibrateDevice() {
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        }
        
        /** * 获取当前日期字符串 (格式: YYYY-MM-DD) */
        function getTodayDateString() {
            const today = new Date();
            const year = today.getFullYear();
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            const day = today.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        /** * 计算给定订单的总价 */
        function calculateTotal(orderData, menuItemsList) {
            let total = 0;
            const menuMap = new Map(menuItemsList.map(item => [item.name, item]));

            for (const itemName in orderData) {
                const quantity = orderData[itemName];
                const item = menuMap.get(itemName);
                if (item) {
                    total += item.price * quantity;
                }
            }
            return total;
        }

        /** * 格式化桌号显示 */
        function formatTableDisplay(table) {
            return (typeof table === 'number' || (!isNaN(parseInt(table)) && String(parseInt(table)) === String(table))) ? `${table}号桌` : String(table);
        }

        // ------------------------------------
        // --- 修正后的：Firebase 数据同步逻辑 ---
        // ------------------------------------

        /** * 修正：初始化 Firebase 并设置所有实时监听器 */
        function initializeFirebase() {
            try {
                if (firebase.apps.length === 0) {
                    app = firebase.initializeApp(firebaseConfig);
                } else {
                    app = firebase.app();
                }
                db = app.database();

                // 定义主要的数据库引用
                menuRef = db.ref('menuItems');
                tablesRef = db.ref('activeTables'); // 仅存储活跃桌号列表
                historyRef = db.ref('history');
                incomeRef = db.ref('income');
                expenseRef = db.ref('expense');

                // 启动所有全局监听器
                listenForMenuUpdates();
                listenForActiveTables();

            } catch (e) {
                console.error("Firebase 初始化失败:", e);
                alert("Firebase 初始化失败，请检查配置信息和网络连接。");
            }
        }

        /** * 修正：监听菜单数据更新，并重新渲染菜单区 */
        function listenForMenuUpdates() {
            menuRef.on('value', (snapshot) => {
                const menuData = snapshot.val();
                menuItems = [];
                if (menuData) {
                    // Firebase 返回的是对象，将其转换为数组
                    for (const key in menuData) {
                        menuItems.push({ id: key, ...menuData[key] });
                    }
                }
                
                // 确保菜单不为空，否则写入默认菜单
                if (menuItems.length === 0) {
                    writeDefaultMenu();
                } else {
                    renderMenuArea();
                    // 如果在编辑模式，也更新编辑区
                    if(isEditMode) {
                        renderMenuEditor();
                    }
                }
                // 菜单更新后，需要重新触发当前账单的计算
                updateBillDisplay();
            });
        }

        /** * 修正：监听活跃桌号列表更新 */
        function listenForActiveTables() {
            tablesRef.on('value', (snapshot) => {
                const tablesObj = snapshot.val() || {};
                activeTables = Object.keys(tablesObj).map(key => {
                    const parsed = parseInt(key);
                    // 保持数字类型
                    return isNaN(parsed) ? key : parsed; 
                }).sort((a, b) => {
                    // 排序逻辑 (数字在前，字符串在后)
                    const aIsNum = typeof a === 'number';
                    const bIsNum = typeof b === 'number';
                    if (aIsNum && bIsNum) return a - b;
                    if (aIsNum) return -1;
                    if (bIsNum) return 1;
                    return String(a).localeCompare(String(b));
                });
                
                // 1. 如果当前桌号不在活跃列表中，切换到第一个桌号
                if (!activeTables.includes(currentTable) && activeTables.length > 0) {
                    switchTable(activeTables[0], false); // 不播放声音，避免频繁切换
                } 
                // 2. 如果没有任何桌子，创建 1 号桌
                else if (activeTables.length === 0) {
                    tablesRef.update({ '1': true }).then(() => {
                        // Firebase 会自动触发 switchTable(1)
                    });
                    
                }
                
                generateTableSelectors();
            });
        }
        
        /** * 修正：监听当前桌子的订单和备注 */
        function listenForCurrentTableData(tableNumber) {
            // 1. 移除旧的监听器
            if (orderListener) db.ref(`tables/${orderListener.table}/order`).off('value', orderListener.callback);
            if (noteListener) db.ref(`tables/${noteListener.table}/note`).off('value', noteListener.callback);

            const safeTableKey = encodeURIComponent(String(tableNumber)).replace(/\./g, '%2E'); // 编码特殊字符，确保 Firebase 路径合法
            currentTableRef = db.ref(`tables/${safeTableKey}`);
            currentOrderRef = db.ref(`tables/${safeTableKey}/order`);
            currentNoteRef = db.ref(`tables/${safeTableKey}/note`);

            // 2. 订单监听器
            const orderCallback = (snapshot) => {
                const order = snapshot.val() || {};
                currentOrderData = order;
                updateBillDisplay();
            };
            currentOrderRef.on('value', orderCallback);
            orderListener = { table: safeTableKey, callback: orderCallback };

            // 3. 备注监听器
            const noteCallback = (snapshot) => {
                const note = snapshot.val() || "";
                currentNoteText = note;
                // 更新输入框和显示区域
                orderNoteInput.value = note;
                currentNoteDisplay.textContent = note ? `备注: ${note}` : "";
            };
            currentNoteRef.on('value', noteCallback);
            noteListener = { table: safeTableKey, callback: noteCallback };
        }

        // ------------------------------------
        // --- 核心点单/数据操作函数 (修正) ---
        // ------------------------------------

        /** * 修正：切换当前操作的桌号 */
        function switchTable(tableNumber, shouldPlaySound = true) {
            if (isEditMode || isSummaryMode) return;

            if (shouldPlaySound) {
                playSound();
                vibrateDevice();
            }
            
            // 保存用户在切换前在输入框中对旧桌号所做的未提交备注修改
            saveNoteFromInput(currentTable);

            currentTable = tableNumber;
            localStorage.setItem('bbq_last_table', currentTable); // 仍然使用 LocalStorage 记录上次使用的桌号

            // 更新顶部显示
            const tableDisplay = formatTableDisplay(currentTable);
            tableSelectorDropbtn.textContent = tableDisplay;
            currentTableDisplay.textContent = tableDisplay;
            settleButton.textContent = `结算并清空${tableDisplay}`;

            // 启动对新桌号数据的实时监听
            listenForCurrentTableData(currentTable);

            // 渲染菜单，确保新的菜单项数量正确
            renderMenuArea();
        }

        /** * 修正：将输入框的备注内容写入 Firebase */
        function saveNoteFromInput(tableToSave) {
            // 注意：这里需要确保写入的是上一个桌号的备注，而非 currentTable 
            // 监听器已经处理了 currentTable 的实时更新
            if (tableToSave) {
                const noteValue = orderNoteInput.value.trim();
                const safeTableKey = encodeURIComponent(String(tableToSave)).replace(/\./g, '%2E');
                db.ref(`tables/${safeTableKey}/note`).set(noteValue || "");
            }
        }

        /** * 修正：更新账单显示 (由 Firebase 监听器调用) */
        function updateBillDisplay() {
            // currentOrderData 和 currentNoteText 已经被 Firebase 实时更新
            const order = currentOrderData;
            const menuMap = new Map(menuItems.map(item => [item.name, item]));
            
            let total = 0;
            billDetails.innerHTML = '';

            // 1. 重新渲染点单明细
            for (const itemName in order) {
                const quantity = order[itemName];
                const item = menuMap.get(itemName);
                
                if (item && quantity > 0) {
                    const subtotal = item.price * quantity;
                    total += subtotal;

                    const row = document.createElement('div');
                    row.className = 'item-row';
                    row.innerHTML = `
                        <span>${itemName} x ${quantity}</span>
                        <span class="item-total">${subtotal.toFixed(0)} Ks</span>
                    `;
                    billDetails.appendChild(row);
                }
            }

            // 2. 更新总价
            totalPriceSpan.textContent = total.toFixed(0);
            
            // 3. 实时更新菜单区数量显示 (关键修正点)
            updateMenuQuantities(order);

            // 4. 更新备注显示 (已由 noteListener 实时更新)
            // currentNoteDisplay.textContent = currentNoteText ? `备注: ${currentNoteText}` : ""; 
        }

        /** * 修正：添加/移除菜品数量 (直接写入 Firebase) */
        function updateQuantity(itemName, delta) {
            // 1. 获取最新的订单数据 (currentOrderData 已经被实时更新)
            let newQuantity = (currentOrderData[itemName] || 0) + delta;

            // 2. 播放声音和震动
            playSound();
            vibrateDevice();

            // 3. 准备写入 Firebase 的数据
            if (newQuantity <= 0) {
                // 如果数量为0或更少，则删除该菜品
                currentOrderRef.child(itemName).remove();
            } else {
                // 否则，更新数量
                currentOrderRef.child(itemName).set(newQuantity);
            }
            
            // 注意: updateBillDisplay 会被 Firebase 监听器自动触发，无需手动调用
        }

        /** * 修正：更新菜单区域的实时数量显示 */
        function updateMenuQuantities(order) {
            const orderData = order || {};
            menuItems.forEach(item => {
                const quantity = orderData[item.name] || 0;
                const quantityInput = document.getElementById(`qty-input-${item.id}`);
                const itemDiv = document.getElementById(`menu-item-${item.id}`);
                
                if (quantityInput) {
                    quantityInput.value = quantity;
                }
                
                // 视觉反馈：突出显示已点菜品
                if (itemDiv) {
                    itemDiv.style.backgroundColor = quantity > 0 ? 'rgba(255, 126, 95, 0.8)' : 'rgba(255, 255, 255, 0.6)';
                }
            });
        }
        
        /** * 修正：添加一个新的动态桌号 */
        function addNewTable() {
            // 1. 查找最小的、未被占用的桌号
            let nextTable = 1; 
            const sortedTables = activeTables.filter(t => typeof t === 'number' && !isNaN(t)).sort((a, b) => a - b);
            for (const tableNum of sortedTables) {
                if (tableNum === nextTable) {
                    nextTable++;
                } else if (tableNum > nextTable) {
                    break; 
                }
            }

            // 2. 弹出输入框供用户自定义
            const customInput = prompt(`输入新桌号 (数字或字母/中文)，留空则使用默认桌号: ${nextTable} 号桌`);
            let newTableIdentifier;
            if (customInput !== null && customInput.trim() !== "") { 
                const trimmedInput = customInput.trim(); 
                const numberCheck = parseInt(trimmedInput); 
                if (!isNaN(numberCheck) && numberCheck > 0 && String(numberCheck) === trimmedInput) { 
                    newTableIdentifier = numberCheck;
                } else { 
                    newTableIdentifier = trimmedInput;
                }
            } else { 
                newTableIdentifier = nextTable;
            } 

            // 3. 校验新桌号是否已存在
            if (activeTables.includes(newTableIdentifier)) {
                alert(`桌号 "${newTableIdentifier}" 已存在，请重新输入。`);
                return;
            }

            // 4. 添加到 Firebase
            const safeTableKey = encodeURIComponent(String(newTableIdentifier)).replace(/\./g, '%2E');
            tablesRef.child(safeTableKey).set(true)
                .then(() => {
                    alert(`已添加 "${formatTableDisplay(newTableIdentifier)}"`);
                    switchTable(newTableIdentifier);
                    // Firebase 监听器会自动更新 activeTables 和 generateTableSelectors
                })
                .catch(error => {
                    console.error("添加桌号失败:", error);
                    alert("添加桌号失败，请检查Firebase规则。");
                });
        }

        /** * 修正：结算并清空当前桌子的订单 (新增回收桌号逻辑) */
        function settleAndClear() {
            const tableToSettle = currentTable;
            const orderData = currentOrderData;
            const total = calculateTotal(orderData, menuItems);
            const currentNote = currentNoteText;
            
            if (total === 0) {
                alert(`桌号 ${formatTableDisplay(tableToSettle)} 账单为空，无需结算。`);
                return;
            }
            
            if (!confirm(`确定结算并清空 ${formatTableDisplay(tableToSettle)} 的 ${total.toFixed(0)} Ks 账单吗?`)) {
                return;
            }

            // 1. 写入历史记录 (Firebase)
            const orderHistory = {
                table: tableToSettle,
                items: orderData,
                total: total,
                note: currentNote,
                date: new Date().toISOString(),
                // 添加一个唯一的 ID 用于汇总查询
                id: Date.now() + '-' + tableToSettle
            };
            historyRef.push(orderHistory).then(() => {
                console.log("历史记录已保存到 Firebase");
            }).catch(e => console.error("保存历史记录失败:", e));
            
            // 2. 清空订单和备注 (Firebase)
            const safeTableKey = encodeURIComponent(String(tableToSettle)).replace(/\./g, '%2E');
            db.ref(`tables/${safeTableKey}`).remove().then(() => {
                console.log(`桌号 ${tableToSettle} 已清空`);
            }).catch(e => console.error("清空桌号失败:", e));

            // 3. 打印账单图片
            printBillToImage();

            // 4. 切换到下一个可用的桌号
            const nextTableIndex = activeTables.indexOf(tableToSettle) + 1;
            let nextTableToSwitch = 1;
            
            if (activeTables.length > nextTableIndex) {
                nextTableToSwitch = activeTables[nextTableIndex];
            } else if (activeTables.length > 1) {
                nextTableToSwitch = activeTables[0];
            } else {
                // 如果只剩下 1 号桌，则切换到 1 号桌（Firebase 监听器会重新创建）
                nextTableToSwitch = 1; 
            }
            
            // 延迟切换，等待 Firebase 反应
            setTimeout(() => {
                switchTable(nextTableToSwitch);
            }, 500);
        }
        
        // ------------------------------------
        // --- 菜单编辑/渲染函数 (修正) ---
        // ------------------------------------

        /** * 修正：写入默认菜单到 Firebase */
        function writeDefaultMenu() {
            const defaultMenu = [
                { name: "羊肉串", price: 2000, category: "肉类", image: '' },
                { name: "牛肉串", price: 2500, category: "肉类", image: '' },
                { name: "鸡翅", price: 3000, category: "肉类", image: '' },
                { name: "烤鱼", price: 5000, category: "海鲜/水产", image: '' },
                { name: "烤虾", price: 4000, category: "海鲜/水产", image: '' },
                { name: "烤玉米", price: 1500, category: "素菜", image: '' },
                { name: "烤茄子", price: 2000, category: "素菜", image: '' },
                { name: "啤酒", price: 3500, category: "酒水/饮料", image: '' },
                { name: "可乐", price: 1000, category: "酒水/饮料", image: '' },
                { name: "烤韭菜", price: 1500, category: "素菜", image: '' }
            ];
            
            const menuUpdates = {};
            defaultMenu.forEach(item => {
                // 使用菜品名作为 key 的基础，确保唯一性
                const safeKey = item.name.replace(/[.#$/[\]]/g, '_'); 
                menuUpdates[safeKey] = item;
            });

            menuRef.update(menuUpdates).then(() => {
                console.log("默认菜单已写入 Firebase");
            }).catch(e => console.error("写入默认菜单失败:", e));
        }


        /** * 修正：保存所有菜单项到 Firebase */
        function saveAllMenuItems() {
            const editorBody = document.getElementById('menu-editor-body');
            const rows = editorBody.getElementsByTagName('tr');
            const newMenu = {};
            let hasError = false;

            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const id = row.getAttribute('data-id');
                const name = row.querySelector('.name-input').value.trim();
                const price = parseFloat(row.querySelector('.price-input').value);
                const category = row.querySelector('.category-input').value.trim() || '其他';
                const image = row.querySelector('.image-input').value.trim() || '';

                if (name === '' || isNaN(price) || price <= 0) {
                    alert(`第 ${i + 1} 行菜品数据无效：名称、价格不能为空或小于等于0。`);
                    hasError = true;
                    break;
                }
                
                // 确保 Firebase 键的合法性，同时保留 ID
                const safeKey = id && id !== 'new' ? id : name.replace(/[.#$/[\]]/g, '_') + '_' + Date.now(); 

                newMenu[safeKey] = { name, price, category, image };
            }

            if (!hasError) {
                // 覆盖整个菜单节点
                menuRef.set(newMenu)
                    .then(() => {
                        alert("菜单保存成功并已同步到云端！");
                        toggleEditMode(); // 返回点单界面
                    })
                    .catch(error => {
                        console.error("菜单保存失败:", error);
                        alert("菜单保存失败，请检查网络或Firebase规则。");
                    });
            }
        }
        
        /** * 修正：删除菜单项 (从 Firebase 删除) */
        function deleteItem(id) {
            if (confirm("确定删除此菜品吗？云端数据将同步删除。")) {
                menuRef.child(id).remove()
                    .then(() => {
                        // Firebase 监听器会自动更新 menuItems 和 UI
                        console.log(`菜品 ${id} 已删除`);
                    })
                    .catch(error => {
                        console.error("删除菜单项失败:", error);
                        alert("删除菜单项失败，请检查网络或Firebase规则。");
                    });
            }
        }

        // ------------------------------------
        // --- 汇总/历史记录函数 (修正) ---
        // ------------------------------------

        /** * 修正：从 Firebase 加载历史订单 */
        async function loadHistoryOrders() {
            return new Promise((resolve, reject) => {
                historyRef.once('value', (snapshot) => {
                    const historyObj = snapshot.val();
                    const historyArray = [];
                    if (historyObj) {
                        for (const key in historyObj) {
                            historyArray.push({ fbKey: key, ...historyObj[key] });
                        }
                    }
                    // 按时间降序排序
                    historyArray.sort((a, b) => new Date(b.date) - new Date(a.date));
                    resolve(historyArray);
                }, (error) => {
                    console.error("加载历史订单失败:", error);
                    reject(error);
                });
            });
        }
        
        /** * 修正：从 Firebase 加载收入记录 */
        async function loadIncomeRecords() {
            return new Promise((resolve, reject) => {
                incomeRef.once('value', (snapshot) => {
                    const incomeObj = snapshot.val();
                    const incomeArray = [];
                    if (incomeObj) {
                        for (const key in incomeObj) {
                            incomeArray.push({ fbKey: key, ...incomeObj[key] });
                        }
                    }
                    incomeArray.sort((a, b) => new Date(b.date) - new Date(a.date));
                    resolve(incomeArray);
                }, (error) => {
                    console.error("加载收入记录失败:", error);
                    reject(error);
                });
            });
        }
        
        /** * 修正：从 Firebase 加载支出记录 */
        async function loadExpenseRecords() {
            return new Promise((resolve, reject) => {
                expenseRef.once('value', (snapshot) => {
                    const expenseObj = snapshot.val();
                    const expenseArray = [];
                    if (expenseObj) {
                        for (const key in expenseObj) {
                            expenseArray.push({ fbKey: key, ...expenseObj[key] });
                        }
                    }
                    expenseArray.sort((a, b) => new Date(b.date) - new Date(a.date));
                    resolve(expenseArray);
                }, (error) => {
                    console.error("加载支出记录失败:", error);
                    reject(error);
                });
            });
        }

        /** * 修正：添加其他收入到 Firebase */
        function addIncome() {
            const date = document.getElementById('income-date').value;
            const description = document.getElementById('income-description').value.trim();
            const amount = parseFloat(document.getElementById('income-amount').value);

            if (!date || description === '' || isNaN(amount) || amount <= 0) {
                alert("请输入有效的日期、描述和金额。");
                return;
            }

            const newIncome = {
                date: date,
                description: description,
                amount: amount,
                timestamp: new Date().toISOString(),
                type: 'other' // 标记为其他收入
            };

            incomeRef.push(newIncome).then(() => {
                alert("收入记录成功同步到云端！");
                // 刷新界面
                showSummaryView('income'); 
                document.getElementById('income-description').value = '';
                document.getElementById('income-amount').value = '';
            }).catch(e => console.error("添加收入失败:", e));
        }
        
        /** * 修正：添加支出到 Firebase */
        function addExpense() {
            const date = document.getElementById('expense-date').value;
            const description = document.getElementById('expense-description').value.trim();
            const amount = parseFloat(document.getElementById('expense-amount').value);

            if (!date || description === '' || isNaN(amount) || amount <= 0) {
                alert("请输入有效的日期、描述和金额。");
                return;
            }

            const newExpense = {
                date: date,
                description: description,
                amount: amount,
                timestamp: new Date().toISOString()
            };

            expenseRef.push(newExpense).then(() => {
                alert("支出记录成功同步到云端！");
                // 刷新界面
                showSummaryView('expense'); 
                document.getElementById('expense-description').value = '';
                document.getElementById('expense-amount').value = '';
            }).catch(e => console.error("添加支出失败:", e));
        }

        /** * 修正：清空所有历史数据 (从 Firebase 删除) */
        function clearAllHistory() {
             if (!confirm("⚠️ 警告：您确定要清空所有历史订单、收入和支出记录吗？此操作不可逆，云端数据也将被删除。")) {
                return;
            }

            // 清空 Firebase 节点
            historyRef.remove();
            incomeRef.remove();
            expenseRef.remove();
            
            // 清空 LocalStorage 中用于记录当前桌号的 item (可选，但推荐)
            localStorage.removeItem('bbq_last_table');

            // 重新渲染汇总界面
            showSummaryView('profit-loss');
            alert("所有历史数据已成功清空。");
        }
        
        // ------------------------------------
        // --- 界面渲染/切换函数 (保持原样，但依赖 Firebase 数据) ---
        // ------------------------------------

        /** * 渲染桌号下拉菜单 */
        function generateTableSelectors() {
            tableDropdownContent.innerHTML = '';

            activeTables.forEach(table => {
                const tableDisplay = formatTableDisplay(table);
                const tableLink = document.createElement('a');
                // 使用单引号避免 table 是字符串时的问题
                tableLink.setAttribute('onclick', `switchTable('${table}')`); 
                tableLink.href = "#";
                tableLink.textContent = tableDisplay;
                tableDropdownContent.appendChild(tableLink);
            });
            
            // 添加新的桌号链接
            const addLink = document.createElement('a');
            addLink.href = "#";
            addLink.textContent = "+ 添加新桌号";
            addLink.className = "add-table-link";
            addLink.setAttribute('onclick', 'addNewTable()');
            tableDropdownContent.appendChild(addLink);

            // 确保显示正确的桌号
            const currentTableDisplay = formatTableDisplay(currentTable);
            tableSelectorDropbtn.textContent = currentTableDisplay;
            document.getElementById('current-table-display').textContent = currentTableDisplay;
            settleButton.textContent = `结算并清空${currentTableDisplay}`;
        }
        
        /** * 渲染菜单区 (依赖 menuItems) */
        function renderMenuArea() {
            menuArea.innerHTML = '';
            
            // 1. 根据分类分组
            const categorizedItems = menuItems.reduce((acc, item) => {
                const category = item.category || '其他';
                if (!acc[category]) {
                    acc[category] = [];
                }
                acc[category].push(item);
                return acc;
            }, {});

            // 2. 渲染每个分类
            for (const category in categorizedItems) {
                const section = document.createElement('div');
                section.className = 'category-section';
                
                // 头部
                const header = document.createElement('div');
                header.className = 'category-header';
                header.textContent = category;
                section.appendChild(header);

                // 内容区
                const content = document.createElement('div');
                content.className = 'category-content';
                
                categorizedItems[category].forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'item';
                    // 使用 Firebase ID 作为 DOM ID
                    itemDiv.id = `menu-item-${item.id}`; 
                    
                    // 点击整个卡片即增加数量
                    itemDiv.onclick = () => updateQuantity(item.name, 1);

                    itemDiv.innerHTML = `
                        <img src="${item.image || defaultPlaceholder}" alt="${item.name}" class="item-image" onerror="this.onerror=null;this.src='${defaultPlaceholder}';">
                        <div class="item-info">
                            <h3>${item.name}</h3>
                            <p>${item.price.toFixed(0)} Ks</p>
                        </div>
                        <div class="item-controls" onclick="event.stopPropagation()">
                            <button onclick="updateQuantity('${item.name}', -1)">-</button>
                            <input type="number" id="qty-input-${item.id}" value="0" min="0" readonly>
                            <button onclick="updateQuantity('${item.name}', 1)">+</button>
                        </div>
                    `;
                    content.appendChild(itemDiv);
                });
                
                section.appendChild(content);
                menuArea.appendChild(section);
            }
            
            // 渲染完毕后，立即更新数量显示
            updateMenuQuantities(currentOrderData);
        }

        /** * 渲染菜单编辑区 (依赖 menuItems) */
        function renderMenuEditor() {
            const editorBody = document.getElementById('menu-editor-body');
            editorBody.innerHTML = '';

            menuItems.forEach(item => {
                const row = editorBody.insertRow();
                // 存储 Firebase ID
                row.setAttribute('data-id', item.id); 
                
                row.innerHTML = `
                    <td><input type="text" value="${item.name}" class="name-input"></td>
                    <td><input type="number" value="${item.price}" class="price-input"></td>
                    <td><input type="text" value="${item.category || ''}" class="category-input"></td>
                    <td><input type="text" value="${item.image || ''}" class="image-input"></td>
                    <td>
                        <button onclick="deleteItem('${item.id}')" style="background-color: #e74c3c;">删除</button>
                    </td>
                `;
            });
        }
        
        /** * 添加新菜品到编辑区 */
        function addNewItem() {
            const editorBody = document.getElementById('menu-editor-body');
            const row = editorBody.insertRow();
            // 标记为新项目
            row.setAttribute('data-id', 'new'); 
            
            row.innerHTML = `
                <td><input type="text" value="" placeholder="菜品名称" class="name-input"></td>
                <td><input type="number" value="" placeholder="价格" class="price-input"></td>
                <td><input type="text" value="" placeholder="分类 (可选)" class="category-input"></td>
                <td><input type="text" value="" placeholder="图片URL (可选)" class="image-input"></td>
                <td>
                    <button onclick="row.remove()" style="background-color: #e74c3c;">移除</button>
                </td>
            `;
        }

        /** * 切换编辑模式 */
        function toggleEditMode() {
            isEditMode = !isEditMode;
            mainContent.style.display = isEditMode || isSummaryMode ? 'none' : 'flex';
            editContent.style.display = isEditMode ? 'block' : 'none';
            summaryContent.style.display = 'none';

            if (isEditMode) {
                renderMenuEditor();
                editLink.textContent = '返回点单';
                summaryLink.textContent = '查看汇总';
            } else {
                editLink.textContent = '编辑菜单';
            }
        }
        
        /** * 切换汇总模式 */
        function toggleSummaryMode() {
            isSummaryMode = !isSummaryMode;
            mainContent.style.display = isSummaryMode || isEditMode ? 'none' : 'flex';
            summaryContent.style.display = isSummaryMode ? 'block' : 'none';
            editContent.style.display = 'none';

            if (isSummaryMode) {
                // 默认显示损益汇总
                showSummaryView('profit-loss'); 
                summaryLink.textContent = '返回点单';
                editLink.textContent = '编辑菜单';
            } else {
                summaryLink.textContent = '查看汇总';
            }
        }
        
        /** * 渲染汇总内容 */
        async function showSummaryView(view) {
            document.getElementById('profit-loss-view').style.display = 'none';
            document.getElementById('income-view').style.display = 'none';
            document.getElementById('expense-view').style.display = 'none';

            // 移除导航栏的激活样式
            document.querySelectorAll('#summary-nav button').forEach(btn => {
                btn.style.opacity = '0.7';
                if (view === 'profit-loss' && btn.textContent.includes('损益')) btn.style.opacity = '1.0';
                if (view === 'income' && btn.textContent.includes('收入')) btn.style.opacity = '1.0';
                if (view === 'expense' && btn.textContent.includes('支出')) btn.style.opacity = '1.0';
            });
            

            if (view === 'profit-loss') {
                document.getElementById('profit-loss-view').style.display = 'block';
                await renderProfitLossSummary();
            } else if (view === 'income') {
                document.getElementById('income-view').style.display = 'block';
                await renderIncomeList();
            } else if (view === 'expense') {
                document.getElementById('expense-view').style.display = 'block';
                await renderExpenseList();
            }
        }

        /** * 修正：渲染损益汇总 (依赖 Firebase 数据) */
        async function renderProfitLossSummary() {
            const history = await loadHistoryOrders();
            const income = await loadIncomeRecords();
            const expense = await loadExpenseRecords();
            
            const summaryContainer = document.getElementById('summary-container');
            summaryContainer.innerHTML = '';
            
            const dailySummary = {};
            let grandTotal = 0;

            // 1. 汇总销售收入
            history.forEach(order => {
                const date = new Date(order.date).toISOString().split('T')[0];
                if (!dailySummary[date]) {
                    dailySummary[date] = { sales: 0, income: 0, expense: 0, orders: [] };
                }
                dailySummary[date].sales += order.total;
                dailySummary[date].orders.push(order);
                grandTotal += order.total;
            });
            
            // 2. 汇总其他收入
            income.forEach(record => {
                const date = record.date;
                if (!dailySummary[date]) {
                    dailySummary[date] = { sales: 0, income: 0, expense: 0, orders: [] };
                }
                dailySummary[date].income += record.amount;
                grandTotal += record.amount;
            });
            
            // 3. 汇总支出
            expense.forEach(record => {
                const date = record.date;
                if (!dailySummary[date]) {
                    dailySummary[date] = { sales: 0, income: 0, expense: 0, orders: [] };
                }
                dailySummary[date].expense += record.amount;
                grandTotal -= record.amount; // 支出是负值
            });
            
            // 4. 渲染结果
            const sortedDates = Object.keys(dailySummary).sort((a, b) => b.localeCompare(a));
            
            sortedDates.forEach(date => {
                const summary = dailySummary[date];
                const dailyProfit = summary.sales + summary.income - summary.expense;
                
                const section = document.createElement('div');
                section.className = 'daily-summary-section';
                section.innerHTML = `
                    <h3>${date} 损益</h3>
                    <p>销售收入: <span style="color: #27ae60;">+${summary.sales.toFixed(0)} Ks</span></p>
                    <p>其他收入: <span style="color: #27ae60;">+${summary.income.toFixed(0)} Ks</span></p>
                    <p>总支出: <span style="color: #e74c3c;">-${summary.expense.toFixed(0)} Ks</span></p>
                    <p class="daily-total">当日总损益: <span style="color: ${dailyProfit >= 0 ? '#27ae60' : '#e74c3c'};">${dailyProfit.toFixed(0)} Ks</span></p>
                    <button onclick="toggleOrderDetails(this)" style="background-color: #3498db; margin-top: 10px;">查看当日详情 (${summary.orders.length} 笔订单)</button>
                    <div class="order-details" style="display: none;">
                        ${summary.orders.map(order => `
                            <div style="border-bottom: 1px dotted #ccc; padding: 5px 0;">
                                <p><strong>桌号: ${formatTableDisplay(order.table)}</strong> | 时间: ${new Date(order.date).toLocaleTimeString()}</p>
                                <ul class="order-items">
                                    ${Object.keys(order.items).map(name => 
                                        `<li>${name} x ${order.items[name]}</li>`
                                    ).join('')}
                                </ul>
                                <p style="text-align: right;"><strong>总计: ${order.total.toFixed(0)} Ks</strong></p>
                                ${order.note ? `<p style="font-size: 0.9em; color: #555;">备注: ${order.note}</p>` : ''}
                            </div>
                        `).join('')}
                        ${income.filter(i => i.date === date).map(i => `
                            <div style="border-top: 1px dashed #ccc; padding-top: 5px;">
                                <p style="color: #27ae60;"><strong>[收入]</strong> ${i.description}: +${i.amount.toFixed(0)} Ks</p>
                            </div>
                        `).join('')}
                        ${expense.filter(e => e.date === date).map(e => `
                            <div style="border-top: 1px dashed #ccc; padding-top: 5px;">
                                <p style="color: #e74c3c;"><strong>[支出]</strong> ${e.description}: -${e.amount.toFixed(0)} Ks</p>
                            </div>
                        `).join('')}
                    </div>
                `;
                summaryContainer.appendChild(section);
            });
            
            document.getElementById('grand-total').textContent = `总损益: ${grandTotal.toFixed(0)} Ks`;
        }

        /** * 渲染收入列表 (依赖 Firebase 数据) */
        async function renderIncomeList() {
            const incomeListDiv = document.getElementById('income-list');
            incomeListDiv.innerHTML = '';
            
            const history = await loadHistoryOrders();
            const income = await loadIncomeRecords();
            
            // 将销售订单格式化为收入记录
            const salesIncome = history.map(order => ({
                date: new Date(order.date).toISOString().split('T')[0],
                description: `销售收入 (桌号: ${formatTableDisplay(order.table)})`,
                amount: order.total,
                timestamp: order.date,
                type: 'sales',
                fbKey: order.fbKey
            }));
            
            const allIncome = [...salesIncome, ...income];
            allIncome.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            let totalIncome = 0;

            const table = document.createElement('table');
            table.style.width = '100%';
            table.innerHTML = `
                <thead>
                    <tr><th>日期</th><th>描述</th><th>类型</th><th>金额 (Ks)</th><th>操作</th></tr>
                </thead>
                <tbody>
                    ${allIncome.map(record => {
                        totalIncome += record.amount;
                        const typeText = record.type === 'sales' ? '销售订单' : '其他收入';
                        const deleteBtn = record.type === 'sales' ? 
                            `<button onclick="deleteHistoryItem('${record.fbKey}', 'history')" style="background-color: #e74c3c; padding: 5px 10px;">删除订单</button>` : 
                            `<button onclick="deleteHistoryItem('${record.fbKey}', 'income')" style="background-color: #e74c3c; padding: 5px 10px;">删除</button>`;
                            
                        return `
                            <tr>
                                <td>${record.date}</td>
                                <td>${record.description}</td>
                                <td>${typeText}</td>
                                <td style="text-align: right; color: #27ae60;">+${record.amount.toFixed(0)}</td>
                                <td>${deleteBtn}</td>
                            </tr>
                        `;
                    }).join('')}
                    <tr style="font-weight: bold; border-top: 2px solid #ccc;">
                        <td></td><td></td><td>总计:</td>
                        <td style="text-align: right; color: #27ae60;">+${totalIncome.toFixed(0)}</td><td></td>
                    </tr>
                </tbody>
            `;
            
            incomeListDiv.appendChild(table);
        }

        /** * 渲染支出列表 (依赖 Firebase 数据) */
        async function renderExpenseList() {
            const expenseListDiv = document.getElementById('expense-list');
            expenseListDiv.innerHTML = '';
            
            const expense = await loadExpenseRecords();
            expense.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            let totalExpense = 0;

            const table = document.createElement('table');
            table.style.width = '100%';
            table.innerHTML = `
                <thead>
                    <tr><th>日期</th><th>描述</th><th>金额 (Ks)</th><th>操作</th></tr>
                </thead>
                <tbody>
                    ${expense.map(record => {
                        totalExpense += record.amount;
                        return `
                            <tr>
                                <td>${record.date}</td>
                                <td>${record.description}</td>
                                <td style="text-align: right; color: #e74c3c;">-${record.amount.toFixed(0)}</td>
                                <td><button onclick="deleteHistoryItem('${record.fbKey}', 'expense')" style="background-color: #e74c3c; padding: 5px 10px;">删除</button></td>
                            </tr>
                        `;
                    }).join('')}
                    <tr style="font-weight: bold; border-top: 2px solid #ccc;">
                        <td></td><td>总计:</td>
                        <td style="text-align: right; color: #e74c3c;">-${totalExpense.toFixed(0)}</td><td></td>
                    </tr>
                </tbody>
            `;
            
            expenseListDiv.appendChild(table);
        }

        /** * 修正：删除历史记录项（通用） */
        function deleteHistoryItem(fbKey, refName) {
            if (confirm(`确定删除此条 ${refName} 记录吗？云端数据将被删除。`)) {
                let ref;
                if (refName === 'history') ref = historyRef;
                else if (refName === 'income') ref = incomeRef;
                else if (refName === 'expense') ref = expenseRef;
                else return;

                ref.child(fbKey).remove().then(() => {
                    alert("记录已删除。");
                    // 刷新当前视图
                    if (isSummaryMode) {
                        if (refName === 'history') showSummaryView('profit-loss');
                        else if (refName === 'income') showSummaryView('income');
                        else if (refName === 'expense') showSummaryView('expense');
                    }
                }).catch(e => {
                    console.error("删除失败:", e);
                    alert("删除失败，请检查网络或Firebase规则。");
                });
            }
        }

        /** * 展开/收起订单详情 */
        function toggleOrderDetails(button) {
            const detailsDiv = button.nextElementSibling;
            if (detailsDiv.style.display === 'none' || detailsDiv.style.display === '') {
                detailsDiv.style.display = 'block';
                button.textContent = '隐藏当日详情';
            } else {
                detailsDiv.style.display = 'none';
                button.textContent = `查看当日详情 (${detailsDiv.querySelectorAll('.order-items').length} 笔订单)`;
            }
        }
        
        /** * 导出为 Excel */
        async function exportToExcel() {
            const history = await loadHistoryOrders();
            const income = await loadIncomeRecords();
            const expense = await loadExpenseRecords();
            
            if (history.length === 0 && income.length === 0 && expense.length === 0) {
                alert("没有历史数据可导出。");
                return;
            }

            // 1. 历史订单表
            const historyData = history.map(order => ({
                日期: new Date(order.date).toISOString().split('T')[0],
                时间: new Date(order.date).toLocaleTimeString(),
                桌号: formatTableDisplay(order.table),
                点单详情: Object.keys(order.items).map(name => `${name} x ${order.items[name]}`).join('; '),
                总金额: order.total,
                备注: order.note || '',
            }));
            
            // 2. 收入表 (含销售收入)
            const salesIncome = history.map(order => ({
                日期: new Date(order.date).toISOString().split('T')[0],
                描述: `销售收入 (桌号: ${formatTableDisplay(order.table)})`,
                类型: '销售收入',
                金额: order.total,
                时间戳: order.date
            }));
            const otherIncome = income.map(rec => ({
                日期: rec.date,
                描述: rec.description,
                类型: '其他收入',
                金额: rec.amount,
                时间戳: rec.timestamp
            }));
            const incomeData = [...salesIncome, ...otherIncome].sort((a, b) => a.时间戳.localeCompare(b.时间戳)).map(i => ({
                日期: i.日期, 描述: i.描述, 类型: i.类型, 金额: i.金额
            }));

            // 3. 支出表
            const expenseData = expense.map(rec => ({
                日期: rec.date,
                描述: rec.description,
                金额: rec.amount,
                时间戳: rec.timestamp
            })).sort((a, b) => a.时间戳.localeCompare(b.时间戳)).map(e => ({
                日期: e.日期, 描述: e.描述, 金额: e.金额
            }));


            // 4. 生成工作簿
            const wb = XLSX.utils.book_new();
            
            if (historyData.length > 0) {
                 const ws1 = XLSX.utils.json_to_sheet(historyData);
                 XLSX.utils.book_append_sheet(wb, ws1, "历史订单");
            }
            if (incomeData.length > 0) {
                 const ws2 = XLSX.utils.json_to_sheet(incomeData);
                 XLSX.utils.book_append_sheet(wb, ws2, "收入记录");
            }
            if (expenseData.length > 0) {
                 const ws3 = XLSX.utils.json_to_sheet(expenseData);
                 XLSX.utils.book_append_sheet(wb, ws3, "支出记录");
            }
            
            XLSX.writeFile(wb, `烧烤账单_${getTodayDateString()}.xlsx`);
            alert("Excel 导出完成！");
        }

        /** * 将账单内容转换为图片并下载 */
        function printBillToImage() {
            // ... (保持原有的 printBillToImage 函数不变，但使用 currentOrderData, currentNoteText) ...
            const tableDisplay = formatTableDisplay(currentTable);
            const currentOrder = currentOrderData;
            const total = calculateTotal(currentOrder, menuItems);
            const currentNote = currentNoteText;
            const now = new Date();
            const timeString = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;

            let printContent = `
                <h2>账单</h2>
                <div class="print-info">
                    <p>日期: ${getTodayDateString()}</p>
                    <p>时间: ${timeString}</p>
                    <p>桌号: ${tableDisplay}</p>
                    ${currentNote ? `<p>备注: ${currentNote}</p>` : ''}
                </div>
                <hr>
            `;
            
            const menuMap = new Map(menuItems.map(item => [item.name, item]));

            for (const itemName in currentOrder) {
                const quantity = currentOrder[itemName];
                const item = menuMap.get(itemName);
                if (item && quantity > 0) {
                    const subtotal = item.price * quantity;
                    printContent += `
                        <div class="print-item">
                            <span>${itemName} x ${quantity}</span>
                            <span>${subtotal.toFixed(0)} Ks</span>
                        </div>
                    `;
                }
            }
            
            printContent += `
                <hr>
                <div class="print-total">
                    <span>总计：</span>
                    <span>${total.toFixed(0)} Ks</span>
                </div>
            `;
            
            printArea.innerHTML = printContent;
            
            // 确保 DOM 元素可见，但移出屏幕外
            const originalDisplay = printArea.style.display;
            printArea.style.display = 'block';
            printArea.style.opacity = '1'; 
            void printArea.offsetWidth; 

            html2canvas(printArea, { 
                scale: 2, 
                useCORS: true, 
                backgroundColor: '#ffffff', 
            }).then(canvas => {
                const imgUrl = canvas.toDataURL('image/png');
                const a = document.createElement('a');
                a.href = imgUrl;
                a.download = `账单-${currentTable}-${getTodayDateString()}-${now.getTime()}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                printArea.style.display = originalDisplay;
                printArea.style.opacity = '0';
                printArea.innerHTML = '';
                
                const customAppScheme = 'myposapp://receipt_complete';
                setTimeout(() => {
                    window.location.href = customAppScheme;
                }, 100);
                
            }).catch(error => {
                console.error("图片生成失败:", error);
                alert("图片生成失败，请检查浏览器控制台。");
                printArea.style.display = originalDisplay;
                printArea.style.opacity = '0';
            });
        }

        // ------------------------------------
        // --- 修正后的：初始化入口点 ---
        // ------------------------------------

        /** * 页面初始化入口点 */
        async function initializeUI() {
            // 1. 初始化 Firebase 并启动所有监听器
            initializeFirebase(); 

            // 2. 尝试从 LocalStorage 加载上次使用的桌号
            let lastTable = localStorage.getItem('bbq_last_table');
            if (lastTable) {
                const numberCheck = parseInt(lastTable);
                // 如果是数字，保持为数字类型
                if (!isNaN(numberCheck) && String(numberCheck) === lastTable) {
                    lastTable = numberCheck;
                }
                currentTable = lastTable;
            } else {
                currentTable = 1; // 默认 1 号桌
            }
            
            // 3. 切换到当前桌号 (会启动订单和备注的监听)
            // Note: listenForActiveTables 监听器在启动时会处理 activeTables.length === 0 的情况
            // 这里只需要在它启动后确保当前桌子被监听
            setTimeout(() => {
                switchTable(currentTable, false);
            }, 1000); 


            // 4. 绑定备注输入框的实时写入事件
            orderNoteInput.addEventListener('input', () => {
                // 实时写入当前桌号的备注到 Firebase
                const noteValue = orderNoteInput.value.trim();
                const safeTableKey = encodeURIComponent(String(currentTable)).replace(/\./g, '%2E');
                db.ref(`tables/${safeTableKey}/note`).set(noteValue || "");
                // 注意：备注显示区会由 noteListener 自动更新
            });

            // 5. 绑定 AudioContext 恢复逻辑到用户首次点击
            document.addEventListener('click', () => {
                if (audioContext && audioContext.state === 'suspended') {
                    audioContext.resume().catch(e => console.error("AudioContext 恢复失败:", e));
                }
            }, { once: true });
        }

        // 绑定 DOMContentLoaded 事件
        document.addEventListener('DOMContentLoaded', () => {
            initializeUI();
        });
    </script>
</body>
</html>
